<!DOCTYPE html>

<html lang="ja">
<head>
<meta charset="UTF-8">
<title>高層気温 観測値 vs 平年値（UTC/JST・偏差）</title>
<style>
body { font-family: sans-serif; }
table { border-collapse: collapse; margin-top: 1em; }
th, td { border: 1px solid #666; padding: 4px 8px; text-align: right; }
th { background: #eee; }
caption { text-align: left; font-weight: bold; }
</style>
</head>
<body>
<h2>高層気温：観測値（Wyoming, UTC） vs 平年値（気象庁, JST）</h2>

<div>
  日時 (UTC): <input id="datetime" value="2023-01-24 12:00" readonly>
  地点番号: <input id="stn" value="47646" readonly>
  <button onclick="loadData()">取得</button>
</div>

<table id="result">
<caption>300 / 500 / 700 / 850 / 925 hPa</caption>
<thead>
<tr>
  <th>気圧(hPa)</th>
  <th>観測値(℃)<br>(UTC)</th>
  <th>平年値(℃)<br>(JST)</th>
  <th>差<br>(観測−平年)</th>
</tr>
</thead>
<tbody></tbody>
</table>

<script>
const TARGET_LEVELS = [300, 500, 700, 850, 925];
const proxy = "https://worker.ryohorita105.workers.dev/?url=";

// JMA 平年値テーブルの列対応（公式HTML固定）
const pressureCols = [
  1000,925,900,850,800,700,600,500,400,350,
  300,250,200,175,150,125,100,70,50,40,
  30,20,15,10,5
];

async function loadData() {
  const dt = document.getElementById('datetime').value;
  const stn = document.getElementById('stn').value;

  const yyyy = parseInt(dt.slice(0,4));
  const mm   = parseInt(dt.slice(5,7));
  const dd   = parseInt(dt.slice(8,10));
  const hh   = parseInt(dt.slice(11,13));

  // ---- UTC → JST（平年値用） ----
  const utcDate = new Date(Date.UTC(yyyy, mm-1, dd, hh));
  const jstDate = new Date(utcDate.getTime() + 9*3600*1000);

  const jstMonth = jstDate.getUTCMonth() + 1;
  const jstHour  = jstDate.getUTCHours();
  const jstDay   = jstDate.getUTCDate();

  const obsUrlRaw = `https://weather.uwyo.edu/wsgi/sounding?datetime=${yyyy}-${String(mm).padStart(2,'0')}-${String(dd).padStart(2,'0')}%20${String(hh).padStart(2,'0')}:00:00&id=${stn}&src=FM35&type=TEXT:LIST`;

  const nmlUrlRaw = `https://www.data.jma.go.jp/stats/etrn/upper/view/nml_snd_d.php?year=&month=${jstMonth}&day=&hour=${jstHour}&point=${stn}&atm=&view=s`;

  const [obsText, nmlHTML] = await Promise.all([
    fetch(proxy + encodeURIComponent(obsUrlRaw)).then(r=>r.text()),
    fetch(proxy + encodeURIComponent(nmlUrlRaw)).then(r=>r.text())
  ]);

  const obs = parseWyoming(obsText);
  const nmlDoc = parseHTML(nmlHTML);

  const tbody = document.querySelector('#result tbody');
  tbody.innerHTML = '';

  for (const p of TARGET_LEVELS) {
    const obsV = obs[p];
    const nmlV = getNmlTemp(nmlDoc, jstDay, p);
    const diff = (obsV != null && nmlV != null) ? (obsV - nmlV).toFixed(1) : '';

    const tr = document.createElement('tr');
    tr.innerHTML = `<th>${p}</th>`+
      `<td>${obsV ?? ''}</td>`+
      `<td>${nmlV ?? ''}</td>`+
      `<td>${diff}</td>`;
    tbody.appendChild(tr);
  }
}

// ---------------- Wyoming ----------------
function parseWyoming(text) {
  const map = {};
  const lines = text.split('\n');
  for (const line of lines) {
    if (/^\s*\d+\.\d/.test(line)) {
      const cols = line.trim().split(/\s+/);
      const p = Math.round(parseFloat(cols[0]));
      const t = parseFloat(cols[2]);
      if (TARGET_LEVELS.includes(p) && !isNaN(t)) {
        map[p] = t;
      }
    }
  }
  return map;
}

// ---------------- JMA 平年 ----------------
function parseHTML(html) {
  const doc = document.implementation.createHTMLDocument('');
  doc.documentElement.innerHTML = html;
  return doc;
}

function getNmlTemp(doc, day, pressure) {
  const table = doc.querySelector('#tablefix1');
  if (!table) return null;

  const rows = table.querySelectorAll('tr.mtx');
  const colIndex = pressureCols.indexOf(pressure);
  if (colIndex === -1) return null;

  for (const row of rows) {
    const th = row.querySelector('th');
    if (!th) continue;

    const m = th.textContent.match(/^(\d+)日$/);
    if (!m) continue;

    if (parseInt(m[1],10) !== day) continue;

    const td = row.querySelectorAll('td')[colIndex];
    if (!td) return null;

    const txt = td.textContent.trim();
    if (txt === '///') return null;

    return parseFloat(txt);
  }
  return null;
}
</script>

</body>
</html>
