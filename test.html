<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Upper-air Obs vs Normal</title>
<style>
table { border-collapse: collapse; margin-top: 10px; }
th, td { border: 1px solid #666; padding: 4px 6px; text-align: right; }
th { background: #eee; }
caption { text-align: left; font-weight: bold; margin-bottom: 6px; }
</style>
</head>
<body>

<h2>高層観測 平年差表示</h2>
<pre id="info"></pre>
<div id="result"></div>

<script>
const proxy = "https://worker.ryohorita105.workers.dev/?url=";

// ---- 入力条件（UTC） ----
const point = 47646;
const utcDate = new Date(Date.UTC(2023, 0, 24, 12)); // 2023/1/24 21UTC

// ---- 時刻整理 ----
const utcY = utcDate.getUTCFullYear();
const utcM = utcDate.getUTCMonth() + 1;
const utcD = utcDate.getUTCDate();
const utcH = utcDate.getUTCHours();

// JST（平年値用）
const jstDate = new Date(utcDate.getTime() + 9 * 3600 * 1000);
const jstM = jstDate.getMonth() + 1;
const jstD = jstDate.getDate();
const jstH = jstDate.getHours();

// ---- 表示情報 ----
document.getElementById("info").textContent =
`地点: ${point}
観測: ${utcY}/${utcM}/${utcD} ${utcH}UTC
平年: ${jstM}月${jstD}日 ${jstH}JST`;

// ---- URL ----
const obsUrl =
`${proxy}https://www.data.jma.go.jp/obd/stats/etrn/upper/view/daily_snd.php?year=${utcY}&month=${utcM}&day=${utcD}&hour=${utcH}&point=${point}`;

const nmlUrl =
`${proxy}https://www.data.jma.go.jp/obd/stats/etrn/upper/view/nml_snd_d.php?month=${jstM}&hour=${jstH}&point=${point}`;

// ---- 気圧面 ----
const levels = [
  1000,925,900,850,800,700,600,500,400,350,
  300,250,200,175,150,125,100,70,50,40,
  30,20,15,10,5
];

(async () => {

  // ========= 観測値 =========
  const obsHtml = await (await fetch(obsUrl)).text();
  const obsDoc = new DOMParser().parseFromString(obsHtml, "text/html");

  const obsTemps = {};
  obsDoc.querySelectorAll("tr").forEach(tr => {
    const tds = tr.querySelectorAll("td");
    if (tds.length >= 2) {
      const p = parseFloat(tds[0].textContent);
      const t = parseFloat(tds[1].textContent);
      if (!isNaN(p) && !isNaN(t)) obsTemps[p] = t;
    }
  });

  // ========= 平年値（1か月表から当日抽出） =========
  const nmlHtml = await (await fetch(nmlUrl)).text();
  const nmlDoc = new DOMParser().parseFromString(nmlHtml, "text/html");

  const nmlTemps = {};
  const table = nmlDoc.querySelector("#tablefix1");

  if (table) {
    const rows = Array.from(table.querySelectorAll("tr"));
    const dayRow = rows.find(r => {
      const th = r.querySelector("th");
      return th && th.textContent.trim() === `${jstD}日`;
    });

    if (dayRow) {
      const cells = dayRow.querySelectorAll("td");
      levels.forEach((p, i) => {
        const v = cells[i]?.textContent.trim();
        nmlTemps[p] = (!v || v === "///") ? null : parseFloat(v);
      });
    }
  }

  // ========= 表示 =========
  let html = `<table>
  <caption>気温（℃） 観測 − 平年</caption>
  <tr><th>hPa</th><th>観測</th><th>平年</th><th>偏差</th></tr>`;

  levels.forEach(p => {
    const o = obsTemps[p];
    const n = nmlTemps[p];
    const d = (o != null && n != null) ? (o - n).toFixed(1) : "";
    html += `<tr>
      <th>${p}</th>
      <td>${o ?? ""}</td>
      <td>${n ?? ""}</td>
      <td>${d}</td>
    </tr>`;
  });

  html += "</table>";
  document.getElementById("result").innerHTML = html;

})();
</script>
</body>
</html>
