<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MSM温位エマグラム</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
    }
    canvas {
      border: 1px solid #ccc;
      margin-top: 10px;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }
    #controls {
      margin-top: 10px;
    }
    select {
      margin: 0 10px;
    }
    #loading {
      color: red;
      font-size: 1.5em;
      margin: 10px;
    }
  </style>
</head>
<body>
  <h1>MSM温位エマグラム</h1>
  <div id="loading">読み込み中...</div>

  <div id="controls">
    <span id="initTimeText"></span>
    <br><br>

    <label>地域:</label>
    <select id="regionSelector"></select>

    <label>地点:</label>
    <select id="stationSelector"></select>

    <label>FT=</label>
    <select id="timeSelector"></select>

    <span id="targetTimeText"></span>
  </div>

  <canvas id="emagramCanvas" width="1200" height="600"></canvas>

<script>
/* =========================
   基本状態
========================= */
let chartInstance = null;
let weatherData = null;
const DISPLAY_MAX = 39;
const STEP = 3;
let currentStation = "44132";
let currentRegion = -1;

/* =========================
   主要都市（-1）
========================= */
const majorStations = {
  "12442": "旭川","14163": "札幌","19432": "釧路","31312": "青森","33431": "盛岡",
  "32402": "秋田","34392": "仙台","41277": "宇都宮","44132": "東京","54232": "新潟",
  "48156": "長野","56227": "金沢","50331": "静岡","51106": "名古屋","62078": "大阪",
  "66408": "岡山","68132": "松江","67437": "広島","72086": "高松","73166": "松山",
  "82182": "福岡","88317": "鹿児島","91197": "那覇"
};

/* =========================
   地域定義
========================= */
const regions = {
  "-1": "主要都市",
  "0": "北海道",
  "1": "東北",
  "2": "関東甲信",
  "3": "東海北陸",
  "4": "近畿",
  "5": "中国四国",
  "6": "九州",
  "7": "沖縄"
};

/* =========================
   DOM
========================= */
const regionSelector = document.getElementById("regionSelector");
const stationSelector = document.getElementById("stationSelector");
const timeSelector = document.getElementById("timeSelector");
const initTimeText = document.getElementById("initTimeText");
const targetTimeText = document.getElementById("targetTimeText");
const loadingDiv = document.getElementById("loading");

/* =========================
   初期時刻
========================= */
const pad = n => n.toString().padStart(2,"0");
const initDateObj = new Date(Date.now() - 2.5 * 3600000);
initDateObj.setUTCHours(Math.floor(initDateObj.getUTCHours()/12)*12,0,0,0);
const initTimeStr =
  `${initDateObj.getUTCFullYear()}${pad(initDateObj.getUTCMonth()+1)}${pad(initDateObj.getUTCDate())}${pad(initDateObj.getUTCHours())}0000`;

initTimeText.textContent =
  `初期値：${initDateObj.getUTCFullYear()}年${pad(initDateObj.getUTCMonth()+1)}月${pad(initDateObj.getUTCDate())}日${pad(initDateObj.getUTCHours())}UTC`;

/* =========================
   FT
========================= */
for (let v = 0; v <= DISPLAY_MAX; v += STEP) {
  const o = document.createElement("option");
  o.value = v;
  o.textContent = v;
  timeSelector.appendChild(o);
}

/* =========================
   地域プルダウン
========================= */
for (const [k, v] of Object.entries(regions)) {
  const o = document.createElement("option");
  o.value = k;
  o.textContent = v;
  if (+k === -1) o.selected = true;
  regionSelector.appendChild(o);
}

/* =========================
   地点取得
========================= */
async function loadStations(region) {
  stationSelector.innerHTML = "";

  if (region == -1) {
    for (const [code, name] of Object.entries(majorStations)) {
      const o = document.createElement("option");
      o.value = code;
      o.textContent = name;
      if (code === currentStation) o.selected = true;
      stationSelector.appendChild(o);
    }
    return;
  }

  const proxy = "https://api.allorigins.win/raw?url=";
  const url = proxy + encodeURIComponent(
    `https://lab.weathermap.co.jp/GPV_point_api/v1/points.php?a=${region}`
  );

  const res = await fetch(url);
  const data = await res.json();

  for (const [code, name] of Object.entries(data)) {
    const o = document.createElement("option");
    o.value = code;
    o.textContent = name;
    stationSelector.appendChild(o);
  }

  currentStation = stationSelector.value;
}

/* =========================
   MSM取得
========================= */
async function fetchWeatherData(stationCode) {
  const proxy = "https://api.allorigins.win/raw?url=";
  const url = proxy + encodeURIComponent(
    `https://lab.weathermap.co.jp/GPV_point_api/v1/get.py?model=MSM&ini=${initTimeStr}&ftmax=78&amedas=${stationCode}`
  );
  const res = await fetch(url);
  return await res.json();
}

/* =========================
   以下 ★あなたの元コード完全コピー★
   （plotEmagram / 計算 / tooltip /
    LFC / EL / K-index / TT / 矢印キー）
========================= */

/* ★★ ここから下は、直前にあなたが貼った
       <script> 内の内容を
       一切変更せずそのまま置いてください ★★ */

</script>
</body>
</html>
