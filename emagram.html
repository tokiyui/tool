<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MSM温位エマグラム</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
    }
    canvas {
      border: 1px solid #ccc;
      margin-top: 10px;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }
    #controls {
      margin-top: 10px;
    }
    select {
      margin: 0 10px;
    }
    #loading {
      color: red;
      font-size: 1.5em;
      margin: 10px;
    }
  </style>
</head>
<body>
  <h1>MSM温位エマグラム</h1>
  <div id="loading">読み込み中...</div>

  <div id="controls">
    <span id="initTimeText"></span>
    <br><br>

    <label>地域:</label>
    <select id="regionSelector"></select>

    <label>地点:</label>
    <select id="stationSelector"></select>

    <label>FT=</label>
    <select id="timeSelector"></select>

    <span id="targetTimeText"></span>
  </div>

  <canvas id="emagramCanvas" width="1200" height="600"></canvas>

<script>
/* =========================
   基本状態
========================= */
let chartInstance = null;
let weatherData = null;
const DISPLAY_MAX = 39;
const STEP = 3;
let currentStation = "44132";
let currentRegion = -1;

/* =========================
   主要都市（-1）
========================= */
const majorStations = {
  "12442": "旭川","14163": "札幌","19432": "釧路","31312": "青森","33431": "盛岡",
  "32402": "秋田","34392": "仙台","41277": "宇都宮","44132": "東京","54232": "新潟",
  "48156": "長野","56227": "金沢","50331": "静岡","51106": "名古屋","62078": "大阪",
  "66408": "岡山","68132": "松江","67437": "広島","72086": "高松","73166": "松山",
  "82182": "福岡","88317": "鹿児島","91197": "那覇"
};

/* =========================
   地域定義
========================= */
const regions = {
  "-1": "主要都市",
  "0": "北海道",
  "1": "東北",
  "2": "関東甲信",
  "3": "東海北陸",
  "4": "近畿",
  "5": "中国四国",
  "6": "九州",
  "7": "沖縄"
};

/* =========================
   DOM
========================= */
const regionSelector = document.getElementById("regionSelector");
const stationSelector = document.getElementById("stationSelector");
const timeSelector = document.getElementById("timeSelector");
const initTimeText = document.getElementById("initTimeText");
const targetTimeText = document.getElementById("targetTimeText");
const loadingDiv = document.getElementById("loading");

/* =========================
   初期時刻
========================= */
const pad = n => n.toString().padStart(2,"0");
const initDateObj = new Date(Date.now() - 2.5 * 3600000);
initDateObj.setUTCHours(Math.floor(initDateObj.getUTCHours()/12)*12,0,0,0);
const initTimeStr =
  `${initDateObj.getUTCFullYear()}${pad(initDateObj.getUTCMonth()+1)}${pad(initDateObj.getUTCDate())}${pad(initDateObj.getUTCHours())}0000`;

initTimeText.textContent =
  `初期値：${initDateObj.getUTCFullYear()}年${pad(initDateObj.getUTCMonth()+1)}月${pad(initDateObj.getUTCDate())}日${pad(initDateObj.getUTCHours())}UTC`;

/* =========================
   FT
========================= */
for (let v = 0; v <= DISPLAY_MAX; v += STEP) {
  const o = document.createElement("option");
  o.value = v;
  o.textContent = v;
  timeSelector.appendChild(o);
}

/* =========================
   地域プルダウン
========================= */
for (const [k, v] of Object.entries(regions)) {
  const o = document.createElement("option");
  o.value = k;
  o.textContent = v;
  if (+k === -1) o.selected = true;
  regionSelector.appendChild(o);
}

/* =========================
   地点取得
========================= */
async function loadStations(region) {
  stationSelector.innerHTML = "";

  if (region == -1) {
    for (const [code, name] of Object.entries(majorStations)) {
      const o = document.createElement("option");
      o.value = code;
      o.textContent = name;
      if (code === currentStation) o.selected = true;
      stationSelector.appendChild(o);
    }
    return;
  }

  const proxy = "https://corsproxy.io/?";
  const url = proxy + encodeURIComponent(
    `https://lab.weathermap.co.jp/GPV_point_api/v1/points.php?a=${region}`
  );

  const res = await fetch(url);
  const data = await res.json();

  for (const [code, name] of Object.entries(data)) {
    const o = document.createElement("option");
    o.value = code;
    o.textContent = name;
    stationSelector.appendChild(o);
  }

  currentStation = stationSelector.value;
}

/* =========================
   MSM取得
========================= */
async function fetchWeatherData(stationCode) {
  const proxy = "https://api.allorigins.win/raw?url=";
  const url = proxy + encodeURIComponent(
    `https://lab.weathermap.co.jp/GPV_point_api/v1/get.py?model=MSM&ini=${initTimeStr}&ftmax=78&amedas=${stationCode}`
  );
  const res = await fetch(url);
  return await res.json();
}

/* =========================
   計算関数
========================= */
function calculatePotentialTemperature(tempK, pressureHpa) {
  const Rd = 287.05, Cp = 1005, P0 = 1000;
  return tempK * Math.pow(P0 / pressureHpa, Rd / Cp);
}

function calculateEquivalentPotentialTemperature(tempK, pressureHpa, rh) {
  const tempC = tempK - 273.15;
  const es = 6.112 * Math.exp((17.67 * tempC) / (tempC + 243.5));
  const e = rh / 100 * es;
  const lnRatio = Math.log(e / 6.112);
  const Td_K = (243.5 * lnRatio) / (17.67 - lnRatio) + 273.15;
  const w = 0.622 * e / (pressureHpa - e);
  const TLCL = 1 / (1 / (Td_K - 56) + Math.log(tempK / Td_K) / 800) + 56;
  return tempK * Math.pow(1000 / pressureHpa, 0.2854)
       * Math.exp(((3376 / TLCL) - 2.54) * w * (1 + 0.81 * w));
}

function updateTargetTimeText(ftHour) {
  const t = new Date(initDateObj.getTime() + ftHour * 3600000);
  targetTimeText.textContent =
    `対象時刻：${t.getFullYear()}年${pad(t.getMonth()+1)}月${pad(t.getDate())}日${pad(t.getHours())}JST`;
}

/* =========================
   描画
========================= */
async function plotEmagram(displayTime) {
  loadingDiv.style.display = 'block';
  const timeIndex = displayTime / 3;
  updateTargetTimeText(displayTime);

  const levels = Object.keys(weatherData)
    .filter(k => !isNaN(k) && k >= 300)
    .sort((a,b)=>b-a);

  const thetaPoints=[], thetaEPoints=[], satThetaEPoints=[];
  let thetaE950=null;
  let lfcPoint=null, elPoint=null;
  let prevSat=null, prevP=null, prevH=null, prevT=null;

  for(const p of levels){
    const d = weatherData[p];
    const T=d?.TMP?.[timeIndex];
    const RH=d?.RH?.[timeIndex];
    const H=d?.HGT?.[timeIndex];
    if(typeof T==="number" && typeof RH==="number"){
      const th=calculatePotentialTemperature(T,p);
      const the=calculateEquivalentPotentialTemperature(T,p,RH);
      const thes=calculateEquivalentPotentialTemperature(T,p,100);

      thetaPoints.push({x:th,y:p,tempK:T,height:H});
      thetaEPoints.push({x:the,y:p,height:H});
      satThetaEPoints.push({x:thes,y:p,height:H});

      if(p==950) thetaE950=the;

      if(prevSat!==null && thetaE950!==null){
        const d1=thetaE950-prevSat;
        const d2=thetaE950-thes;
        if(d1*d2<0 && p<=925){
          const f=Math.abs(d1)/(Math.abs(d1)+Math.abs(d2));
          const y=prevP+f*(p-prevP);
          const h=prevH+f*(H-prevH);
          const t=prevT+f*(T-prevT);
          if(!lfcPoint) lfcPoint={x:thetaE950,y:y,height:h,tempK:t};
          else if(!elPoint) elPoint={x:thetaE950,y:y,height:h,tempK:t};
        }
      }
      prevSat=thes; prevP=p; prevH=H; prevT=T;
    }
  }

  const T850=weatherData["850"]?.TMP?.[timeIndex];
  const T700=weatherData["700"]?.TMP?.[timeIndex];
  const T500=weatherData["500"]?.TMP?.[timeIndex];
  const RH850=weatherData["850"]?.RH?.[timeIndex];
  const RH700=weatherData["700"]?.RH?.[timeIndex];

  const Td=(T,rh)=>{
    const Tc=T-273.15;
    const es=6.112*Math.exp(17.67*Tc/(Tc+243.5));
    const e=rh/100*es;
    const ln=Math.log(e/6.112);
    return (243.5*ln)/(17.67-ln);
  };

  const Td850=Td(T850,RH850);
  const Td700=Td(T700,RH700);
  const K=T850+Td850-T500-(T700-Td700)+273.15;
  const TT=T850+Td850-2*T500+273.15;

  targetTimeText.textContent+=
    `  K-Index=${K.toFixed(1)}  TotalTotals=${TT.toFixed(1)}  T500=${(T500-273.15).toFixed(1)}`;

  const ctx=document.getElementById("emagramCanvas").getContext("2d");
  if(chartInstance) chartInstance.destroy();

  chartInstance=new Chart(ctx,{
    type:"scatter",
    data:{datasets:[
      {label:"温位 (θ)",data:thetaPoints,showLine:true,borderColor:"red"},
      {label:"相当温位 (θₑ)",data:thetaEPoints,showLine:true,borderColor:"blue"},
      {label:"飽和相当温位 (θₑ*)",data:satThetaEPoints,showLine:true,borderColor:"green"},
      {label:"θₑ(950hPa)",data:[{x:thetaE950,y:950},{x:thetaE950,y:100}],
       showLine:true,borderColor:"black",pointRadius:0},
      {label:"LFC",data:[lfcPoint],backgroundColor:"orange",pointRadius:8},
      {label:"EL",data:[elPoint],backgroundColor:"red",pointRadius:8}
    ]},
    options:{
      responsive:false,animation:false,
      scales:{
        x:{min:240,max:400,title:{display:true,text:"温位 (K)"}},
        y:{type:"logarithmic",reverse:true,min:290,max:1000,
           ticks:{callback:v=>[1000,900,800,700,600,500,400,300].includes(v)?v+" hPa":""}}
      }
    }
  });

  loadingDiv.style.display="none";
}

/* =========================
   初期化・イベント
========================= */
async function initializeAndPlot(ft){
  weatherData = await fetchWeatherData(currentStation);
  await plotEmagram(ft);
}

regionSelector.addEventListener("change", async()=>{
  currentRegion=regionSelector.value;
  await loadStations(currentRegion);
  await initializeAndPlot(parseInt(timeSelector.value));
});

stationSelector.addEventListener("change", async()=>{
  currentStation=stationSelector.value;
  await initializeAndPlot(parseInt(timeSelector.value));
});

timeSelector.addEventListener("change",()=>{
  plotEmagram(parseInt(timeSelector.value));
});

document.addEventListener("keydown",(e)=>{
  let t=parseInt(timeSelector.value);
  if(e.key==="ArrowLeft" && t>0){
    timeSelector.value=t-STEP;
    plotEmagram(t-STEP);
  }
  if(e.key==="ArrowRight" && t<DISPLAY_MAX){
    timeSelector.value=t+STEP;
    plotEmagram(t+STEP);
  }
});

/* =========================
   起動
========================= */
(async()=>{
  await loadStations(currentRegion);
  await initializeAndPlot(0);
})();

</script>
</body>
</html>
