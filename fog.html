<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>空港・アメダス視程一覧</title>

<style>
body{
  font-family:system-ui,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;
  background:#fff;color:#111;margin:0;padding:20px
}
h1{margin-bottom:12px}
h2{margin:0 0 8px;border-left:6px solid #444;padding-left:8px;font-size:18px}
.item{padding:6px 4px;margin:4px 0;font-size:15px;border-radius:4px}
.yellow{background:#ffeb99}
.cyan{background:#cfefff}
.gray{background:#eee;color:#666}

/* 3列 */
#out{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:16px;
}
.area{
  border:1px solid #ddd;
  padding:10px;
  border-radius:6px;
  background:#fafafa;
}

/* スマホ */
@media(max-width:900px){
  #out{grid-template-columns:1fr}
}
</style>
</head>

<body>
<h1>北陸・関東甲信・東海 — 空港・アメダス視程一覧</h1>
<div id="out"></div>

<script>
const CORS_PROXY='https://worker.ryohorita105.workers.dev/?url=';

/* ===== 地点定義 ===== */
const AREAS={
  '北陸':[
    {icao:'RJSN',name:'新潟空港'},{icao:'RJNT',name:'富山空港'},
    {icao:'RJNW',name:'能登空港'},{icao:'RJNK',name:'小松空港'},
    {icao:'RJNF',name:'福井空港'}
  ],
  '関東沿岸':[
    {icao:'RJTT',name:'羽田空港'},{icao:'RJAA',name:'成田空港'},{icao:'RJAH',name:'茨城空港'},
    {icao:'RJTI',name:'東京ヘリポート'},{icao:'RJTC',name:'立川飛行場'},{icao:'RJTF',name:'調布飛行場'},
    {icao:'RJTQ',name:'三宅島空港'},{icao:'RJAZ',name:'神津島空港'},{icao:'RJTO',name:'大島空港'},
    {icao:'RJAN',name:'新島空港'},{icao:'RJTH',name:'八丈島空港'}
  ],
  '関東内陸':[
    {icao:'RJAF',name:'松本空港'}
  ],
  '東海':[
    {icao:'RJGG',name:'中部国際空港'},{icao:'RJNA',name:'名古屋飛行場'},
    {icao:'RJNG',name:'岐阜飛行場'},{icao:'RJNY',name:'静浜飛行場'},
    {icao:'RJNS',name:'静岡空港'}
  ]
};

const AMEDAS_POINTS={
  '北陸':[
    {id:'54232',name:'新潟'},{id:'54157',name:'相川'},{id:'54651',name:'高田'},
    {id:'55102',name:'富山'},{id:'55091',name:'伏木'},{id:'56052',name:'輪島'},
    {id:'56227',name:'金沢'},{id:'57066',name:'福井'},{id:'57248',name:'敦賀'}
  ],
  '関東沿岸':[
    {id:'47662',name:'東京'},{id:'46106',name:'横浜'},{id:'40201',name:'水戸'},{id:'40336',name:'つくば'},
    {id:'45148',name:'銚子'},{id:'45212',name:'千葉'},{id:'45371',name:'勝浦'},{id:'45401',name:'館山'},
    {id:'44172',name:'大島'},{id:'44226',name:'三宅島'},{id:'44263',name:'八丈島'}
  ],
   '関東内陸':[
    {id:'43056',name:'熊谷'},{id:'43156',name:'秩父'},{id:'49142',name:'甲府'},
    {id:'49251',name:'河口湖'},{id:'42251',name:'前橋'},{id:'41277',name:'宇都宮'},
    {id:'41166',name:'奥日光'},{id:'48156',name:'長野'},{id:'48361',name:'松本'},
    {id:'48331',name:'軽井沢'},{id:'48491',name:'諏訪'},{id:'48767',name:'飯田'}
  ],
  '東海':[
    {id:'50331',name:'静岡'},{id:'50206',name:'三島'},{id:'50281',name:'網代'},
    {id:'50456',name:'浜松'},{id:'50551',name:'御前崎'},{id:'50561',name:'石廊崎'},
    {id:'51106',name:'名古屋'},{id:'51346',name:'伊良湖'},{id:'52586',name:'岐阜'},{id:'52146',name:'高山'},
    {id:'53133',name:'津'},{id:'53061',name:'四日市'},{id:'53112',name:'上野'},{id:'53378',name:'尾鷲'}
  ]
};

/* ===== METAR ===== */
function parseMetarText(t){
  const l=t.trim().split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  return l.length<2?null:l[1];
}
function hasPrecip(m){
  return m?/\+RA|-RA|\bRA\b|SHRA|FZRA|RASN|DZ|TSRA|SHSN|SHRASN/i.test(m):false;
}
function parseVisibility(m){
  if(!m)return null;
  const r=m.match(/\b(\d{4})\b/);
  if(!r)return null;
  const v=parseInt(r[1],10);
  return v===9999?10000:v;
}
function parseObsTime(m){
  const r=m.match(/\b(\d{6})Z\b/); if(!r)return null;
  const now=new Date();
  return new Date(Date.UTC(
    now.getUTCFullYear(),now.getUTCMonth(),
    +r[1].slice(0,2),+r[1].slice(2,4),+r[1].slice(4,6)
  ));
}
function formatJST(d){
  return `${String(d.getDate()).padStart(2,'0')}日${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}JST`;
}
async function fetchViaProxy(u){
  const r=await fetch(CORS_PROXY+encodeURIComponent(u));
  if(!r.ok)throw 0;
  return await r.text();
}
async function fetchMETAR(icao){
  try{
    const t=await fetchViaProxy(
      `https://tgftp.nws.noaa.gov/data/observations/metar/stations/${icao}.TXT`
    );
    const m=parseMetarText(t);
    if(!m)return{error:true};
    return{
      vis:parseVisibility(m),
      precip:hasPrecip(m),
      time:parseObsTime(m)
    };
  }catch{
    return{error:true};
  }
}

/* ===== AMeDAS ===== */
async function fetchAmedas(ds){
  const r=await fetch(
    `${CORS_PROXY}https://www.jma.go.jp/bosai/amedas/data/map/${ds}.json`
  );
  return await r.json();
}
function amedasHasPrecip(c){
  return c>=5 && c<=16;
}

/* ===== main ===== */
async function run(){
  const out=document.getElementById('out');
  out.innerHTML='';

  const now=new Date(Math.floor((Date.now()-10*60000)/3600000)*3600000);
  const ds=`${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}${String(now.getHours()).padStart(2,'0')}0000`;
  const amedas=await fetchAmedas(ds);

  for(const area of ['北陸','関東沿岸','関東内陸','東海']){
    const areaDiv=document.createElement('div');
    areaDiv.className='area';
    const h2=document.createElement('h2');
    h2.textContent=area;
    areaDiv.appendChild(h2);

    /* 空港 */
    for(const a of AREAS[area]){
      const d=await fetchMETAR(a.icao);
      const div=document.createElement('div');
      div.className='item';

      if(d.error){
        div.textContent=`${a.name} 取得失敗`;
        div.classList.add('gray');
      }else{
        div.textContent=
          `${a.name} ${d.vis!=null?d.vis+'m':'視程不明'}（${d.time?formatJST(d.time):'時刻不明'}）`;
        if(d.precip)div.classList.add('cyan');
        else if(d.vis!=null && d.vis<=5000)div.classList.add('yellow');
      }
      areaDiv.appendChild(div);
    }

    /* アメダス */
    for(const p of AMEDAS_POINTS[area]){
      const a=amedas[p.id];
      if(!a)continue;

      const vis=(a.visibility&&a.visibility.length)?a.visibility[0]:null;
      const weather=(a.weather&&a.weather.length)?a.weather[0]:null;

      const div=document.createElement('div');
      div.className='item';
      div.textContent=
        `${p.name} ${vis!=null?vis+'m':'視程欠測'}（${formatJST(now)}）`;

      if(weather!=null && amedasHasPrecip(weather))div.classList.add('cyan');
      else if(vis!=null && vis<=5000)div.classList.add('yellow');
      else if(vis==null)div.classList.add('gray');

      areaDiv.appendChild(div);
    }

    out.appendChild(areaDiv);
  }
}

window.addEventListener('load',run);
</script>
</body>
</html>
