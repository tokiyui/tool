<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>空港一覧（視程・感雨ハイライト）</title>
<style>
  body{font-family:system-ui, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif; background:#fff; color:#111; margin:0; padding:20px}
  h2{margin-top:24px; border-left:6px solid #444; padding-left:8px}
  .item{padding:6px 2px; margin:4px 0; font-size:15px; border-radius:4px}
  .yellow{background:#ffeb99}
  .cyan{background:#cfefff}
  #out{margin-top:10px}
</style>
</head>
<body>
<h1>関東甲信 / 北陸 / 東海 — 空港視程一覧</h1>
<div id="out"></div>

<script>
const CORS_PROXY = 'https://worker.ryohorita105.workers.dev/?url=';

// 地方ごとの固定 ICAO リスト
const AREAS = {
  '北陸': [
    {icao:'RJSN', name:'新潟空港'},
    {icao:'RJNK', name:'小松空港'},
    {icao:'RJNT', name:'富山空港'},
    {icao:'RJNF', name:'福井空港'}
  ],
  '関東甲信': [
    {icao:'RJTT', name:'羽田空港'},
    {icao:'RJAA', name:'成田空港'},
    {icao:'RJAH', name:'茨城空港'},
    {icao:'RJTR', name:'横田基地'},
    {icao:'RJTQ', name:'三宅島空港'},
    {icao:'RJTO', name:'大島空港'},
    {icao:'RJTH', name:'八丈島空港'}
  ],
  '東海': [
    {icao:'RJGG', name:'中部国際空港'},
    {icao:'RJNA', name:'名古屋飛行場（小牧）'},
    {icao:'RJNS', name:'静岡空港'}
  ]
};

function parseMetarText(text){
  const lines = text.trim().split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  return lines.length < 2 ? null : lines[1];
}

function hasPrecip(metar){
  if(!metar) return false;
  const re = /\+RA|-RA|\bRA\b|SHRA|FZRA|RASN|DZ|TSRA|SHSN|SHRASN/i;
  return re.test(metar);
}

function parseVisibility(metar){
  if(!metar) return null;
  const m = metar.match(/\b(\d{4})\b/);
  if(!m) return null;
  const v = parseInt(m[1],10);
  return v===9999 ? 10000 : v;
}

function parseObsTime(metar){
  const m = metar.match(/\b(\d{6})Z\b/);
  if(!m) return null;
  const dd = +m[1].slice(0,2);
  const hh = +m[1].slice(2,4);
  const mm = +m[1].slice(4,6);
  const now = new Date();
  const dtUTC = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), dd, hh, mm));
  return new Date(dtUTC.getTime() + 9*3600*1000);
}

function formatJST(dt){
  const d = String(dt.getDate()).padStart(2,'0');
  const h = String(dt.getHours()).padStart(2,'0');
  const m = String(dt.getMinutes()).padStart(2,'0');
  return `${d}日${h}:${m}（時刻はJST）`;
}

async function fetchViaProxy(url){
  const r = await fetch(CORS_PROXY + encodeURIComponent(url));
  if(!r.ok) throw new Error(r.status);
  return await r.text();
}

async function fetchMETAR(icao){
  const url = `https://tgftp.nws.noaa.gov/data/observations/metar/stations/${icao}.TXT`;
  try{
    const txt = await fetchViaProxy(url);
    const metar = parseMetarText(txt);
    if(!metar) return {error:true};
    return {
      metar,
      vis: parseVisibility(metar),
      precip: hasPrecip(metar),
      time: parseObsTime(metar)
    };
  }catch{
    return {error:true};
  }
}

async function run(){
  const out = document.getElementById('out');
  out.innerHTML = '';

  for(const areaName in AREAS){
    const h2 = document.createElement('h2');
    h2.textContent = areaName;
    out.appendChild(h2);

    for(const airport of AREAS[areaName]){
      const div = document.createElement('div');
      div.className = 'item';

      const data = await fetchMETAR(airport.icao);
      if(data.error){
        div.textContent = `${airport.name} 取得失敗`;
        out.appendChild(div);
        continue;
      }

      const visText = data.vis==null ? '視程不明' : `${data.vis}m`;
      const timeText = data.time ? formatJST(data.time) : '(時刻不明)';

      div.textContent = `${airport.name} ${visText}（${timeText}）`;

      if(data.precip) div.classList.add('cyan');
      else if(data.vis!=null && data.vis<=5000) div.classList.add('yellow');

      out.appendChild(div);
    }
  }
}

window.addEventListener('load', ()=>{ run(); });
</script>
</body>
</html>
