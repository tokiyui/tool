<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>風・波統合マップ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
html, body { margin:0; height:100%; }
#map { height:100vh; width:100vw; }
.wind-speed-label {
  font-size: 18px;
  font-weight: bold;
  color: black;
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  pointer-events: none;
}
.leaflet-div-icon {
  background: none;
  border: none;
  pointer-events: auto;
}
.legend {
  background: white;
  padding: 6px 8px;
  font-size: 14px;
  line-height: 18px;
  color: #333;
}
.legend i {
  width: 18px;
  height: 18px;
  float: left;
  margin-right: 6px;
  opacity: 0.8;
}
</style>
</head>
<body>
<div id="map"></div>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const map = L.map("map").setView([36,138],5);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{
  attribution:"&copy; OpenStreetMap contributors"
}).addTo(map);
const proxy = "https://corsproxy.io/?";

// ---------------- 共通関数 ----------------
const getArrowColor = s => s>=20?"red":s>=15?"orange":s>=10?"yellow":"blue";
const windDirToAngleText = dir => ({
 "北":180,"北北東":202.5,"北東":225,"東北東":247.5,
 "東":270,"東南東":292.5,"南東":315,"南南東":337.5,
 "南":0,"南南西":22.5,"南西":45,"西南西":67.5,
 "西":90,"西北西":112.5,"北西":135,"北北西":157.5
}[dir] ?? null);
const windDir16ToText = d=>{
 const dirs=["北","北北東","北東","東北東","東","東南東","南東","南南東",
             "南","南南西","南西","西南西","西","西北西","北西","北北西"];
 return (d>=0&&d<=16)?dirs[d]:null;
};
const windDir16ToAngle = d => (d>=0&&d<=16)?d*22.5+180:null;
const makeWindIcon = (angle,speed,color)=>L.divIcon({
  html:`<div style="position:relative;width:48px;height:48px;">
    <svg width="48" height="48" viewBox="0 0 48 48" style="transform:rotate(${angle}deg);position:absolute;">
      <polygon points="24,2 28,10 24,8 20,10" fill="${color}"/>
      <line x1="24" y1="2" x2="24" y2="28" stroke="${color}" stroke-width="2"/>
    </svg>
    <div class="wind-speed-label">${speed}</div>
  </div>`,
  iconSize:[48,48], iconAnchor:[24,24]
});
const getColor = h=>{
 if(h<0.5)return"dodgerblue";
 if(h<1.0)return"limegreen";
 if(h<1.5)return"greenyellow";
 if(h<2.0)return"gold";
 if(h<3.0)return"darkorange";
 return"orangered";
};
const pointData = {};
const pointKey = (lat, lon) => `${lat.toFixed(3)},${lon.toFixed(3)}`;

// ---------------- データ取得 ----------------
async function fetchAllData(){
  // ここに海保、AMeDAS、NOAA、NOWPHAS、河川局の取得コードを入れる
  // 省略。pointData[key]に以下の形で格納
  // {
  //   lat, lon,
  //   windHtml, iconAngle, iconSpeed, iconColor,
  //   waveHtml, waveHeight
  // }
  // 今回のコード例では前回のコードをそのまま利用
  // （ここでは省略）
  await Promise.all([
    // 海保取得処理
    // AMeDAS取得処理
    // NOAA取得処理
    // NOWPHAS取得処理
    // 河川局取得処理
  ]);
  drawPoints();
}

// ---------------- 描画 ----------------
function drawPoints(){
  Object.values(pointData).forEach(p=>{
    // Popup作成
    let html = "";
    if(p.windHtml) html += p.windHtml + "<br>";
    if(p.iconAngle != null) html += `風向: ${p.windHtml?.match(/風向: (.*)/)?.[1] ?? "不明"}<br>風速: ${p.iconSpeed} m/s<br>`;
    if(p.waveHtml) html += p.waveHtml + "<br>";
    if(p.waveHeight != null) html += `波高: ${p.waveHeight.toFixed(2)} m`;

    // 風アイコン
    if(p.iconAngle != null){
      const marker = L.marker([p.lat,p.lon],{
        icon: makeWindIcon(p.iconAngle,p.iconSpeed,p.iconColor)
      }).addTo(map);
      marker.bindPopup(html,{maxWidth:300});
      marker.on("mouseover", e=>{e.target.openPopup();});
      marker.on("mouseout", e=>{e.target.closePopup();});
    }

    // 波マーカー
    if(p.waveHeight != null){
      const waveMarker = L.circleMarker([p.lat,p.lon],{
        radius:8,
        color:getColor(p.waveHeight),
        fillColor:getColor(p.waveHeight),
        fillOpacity:0.8,
        weight:1
      }).addTo(map);
      waveMarker.bindPopup(html,{maxWidth:300});
      waveMarker.on("mouseover", e=>{e.target.openPopup();});
      waveMarker.on("mouseout", e=>{e.target.closePopup();});
    }
  });
}

// ---------------- 凡例 ----------------
const legend=L.control({position:"bottomright"});
legend.onAdd=function(){
 const d=L.DomUtil.create("div","legend");
 const g=[0,0.5,1,1.5,2,3];
 d.innerHTML+="<b>波高 (m)</b><br>";
 for(let i=0;i<g.length;i++){
  d.innerHTML+=`<i style="background:${getColor(g[i]+0.01)}"></i>${g[i]}${g[i+1]?"–"+g[i+1]:"+"}<br>`;
 }
 return d;
};
legend.addTo(map);

// ---------------- 実行 ----------------
fetchAllData();
</script>
</body>
</html>
