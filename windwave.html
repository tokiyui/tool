<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>風向・波高 統合マップ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
html, body { margin:0; height:100%; }
#map { height:100vh; width:100vw; }
.wind-speed-label {
  font-size:18px; font-weight:bold; color:black;
  text-shadow:1px 1px 2px white;
  position:absolute; top:50%; left:50%;
  transform:translate(-50%,-50%);
  pointer-events:none;
}
.legend {
  background:white; padding:6px 8px;
  font-size:14px; line-height:18px; color:#333;
}
.legend i {
  width:18px; height:18px;
  float:left; margin-right:6px; opacity:0.8;
}
</style>
</head>
<body>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// ================= 地図 =================
const map = L.map("map").setView([36,138],5);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{
  attribution:"&copy; OpenStreetMap contributors"
}).addTo(map);

const proxy = "https://corsproxy.io/?";

// ================= 共通関数 =================
const getArrowColor = s => s>=20?"red":s>=15?"orange":s>=10?"yellow":"blue";

const windDirToAngleText = dir => ({
 "南":0,"南南西":22.5,"南西":45,"西南西":67.5,
 "西":90,"西北西":112.5,"北西":135,"北北西":157.5,
 "北":180,"北北東":202.5,"北東":225,"東北東":247.5,
 "東":270,"東南東":292.5,"南東":315,"南南東":337.5
}[dir] ?? null);

const windDir16ToAngle = d => (d>=0&&d<=16)?d*22.5+180:null;

const makeWindIcon = (angle,speed,color)=>L.divIcon({
  html:`
  <div style="position:relative;width:48px;height:48px;">
    <svg width="48" height="48" viewBox="0 0 48 48"
     style="transform:rotate(${angle}deg);position:absolute;">
      <polygon points="24,2 28,10 24,8 20,10" fill="${color}"/>
      <line x1="24" y1="2" x2="24" y2="28"
       stroke="${color}" stroke-width="2"/>
    </svg>
    <div class="wind-speed-label">${speed}</div>
  </div>`,
  iconSize:[48,48], iconAnchor:[24,24]
});

const getColor = h=>{
 if(h<0.5)return"dodgerblue";
 if(h<1.0)return"limegreen";
 if(h<1.5)return"greenyellow";
 if(h<2.0)return"gold";
 if(h<3.0)return"darkorange";
 return"orangered";
};

const createCircleMarker=(lat,lon,color,html)=>
 L.circleMarker([lat,lon],{
   radius:8,color,fillColor:color,
   fillOpacity:0.8,weight:1
 }).bindTooltip(html).addTo(map);

// ================= 風：海保 =================
fetch(proxy+encodeURIComponent(
 "https://www6.kaiho.mlit.go.jp/micsgis/KishouGenkyouPoint/attribute"+
 "?lon=135&lat=35&stlon=105&stlat=20&edlon=165&edlat=50"
)).then(r=>r.json()).then(d=>{
 d.forEach(e=>{
  if(!e.shp)return;
  const m=e.shp.match(/POINT\(([-\d.]+)\s+([-\d.]+)\)/);
  if(!m)return;
  const lon=+m[1],lat=+m[2];
  const a=windDirToAngleText(e.fuukou);
  const s=parseFloat(e.fuusoku);
  if(a==null||isNaN(s))return;
  L.marker([lat,lon],{
    icon:makeWindIcon(a,s,getArrowColor(s))
  }).addTo(map);
 });
});

// ================= 風：AMeDAS =================
const timeStr=(()=>{
 const d=new Date(); d.setMinutes(d.getMinutes()-10);
 d.setMinutes(Math.floor(d.getMinutes()/10)*10);
 return d.getFullYear()
 +String(d.getMonth()+1).padStart(2,"0")
 +String(d.getDate()).padStart(2,"0")
 +String(d.getHours()).padStart(2,"0")
 +String(d.getMinutes()).padStart(2,"0")+"00";
})();

Promise.all([
 fetch(`https://www.jma.go.jp/bosai/amedas/data/map/${timeStr}.json`).then(r=>r.json()),
 fetch("https://www.jma.go.jp/bosai/amedas/const/amedastable.json").then(r=>r.json())
]).then(([a,t])=>{
 Object.keys(a).forEach(c=>{
  const o=a[c],m=t[c];
  if(!m)return;
  const s=o.wind?.[0],d=o.windDirection?.[0];
  if(s==null||d==null||s<10)return;
  const ang=windDir16ToAngle(d);
  const lat=m.lat[0]+m.lat[1]/60;
  const lon=m.lon[0]+m.lon[1]/60;
  L.marker([lat,lon],{
   icon:makeWindIcon(ang,s.toFixed(1),getArrowColor(s))
  }).addTo(map);
 });
});

// ================= NOAA 風＋波 =================
fetch(proxy+encodeURIComponent(
 "https://www.ndbc.noaa.gov/ship_obs.php?uom=M&time=2"
)).then(r=>r.text()).then(txt=>{
 (txt.match(/<span>SHIP.*?<\/span>/g)||[]).forEach(s=>{
  const p=s.replace(/<[^>]+>/g,"").trim().split(/\s+/);
  if(p.length<8)return;
  const lat=+p[2],lon=+p[3];
  if(lat<15||lat>60||lon<90||lon>180)return;

  const wdir=+p[4],wspd=+p[5];
  if(!isNaN(wdir)&&!isNaN(wspd)){
   L.marker([lat,lon],{
    icon:makeWindIcon(wdir,wspd.toFixed(1),getArrowColor(wspd))
   }).addTo(map);
  }

  const wv=+p[7]*0.3048;
  if(!isNaN(wv)){
   createCircleMarker(lat,lon,getColor(wv),
    `Ship (${wv.toFixed(2)} m)`);
  }
 });
});

// ================= 凡例 =================
const legend=L.control({position:"bottomright"});
legend.onAdd=function(){
 const d=L.DomUtil.create("div","legend");
 const g=[0,0.5,1,1.5,2,3];
 d.innerHTML+="<b>波高 (m)</b><br>";
 for(let i=0;i<g.length;i++){
  const f=g[i],t=g[i+1];
  d.innerHTML+=
   `<i style="background:${getColor(f+0.01)}"></i>
    ${f}${t?"–"+t:"+"}<br>`;
 }
 return d;
};
legend.addTo(map);
</script>
</body>
</html>
