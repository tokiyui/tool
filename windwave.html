<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>風向＋波高 統合マップ（NaN除外）</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html, body { margin:0; height:100%; }
#map { height:100vh; }

.wind-speed-label {
  font-size:14px;
  font-weight:bold;
  color:black;
  text-shadow:1px 1px 2px white;
  position:absolute;
  top:50%; left:50%;
  transform:translate(-50%,-50%);
  pointer-events:none;
}

.legend {
  background:white;
  padding:6px;
  font-size:13px;
}
.legend i {
  width:16px; height:16px;
  float:left; margin-right:6px;
  opacity:0.8;
}
</style>
</head>

<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// =====================
// Map
// =====================
const map = L.map("map").setView([36,138],5);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution:"© OpenStreetMap"
}).addTo(map);

const proxy = "https://corsproxy.io/?";

// =====================
// Layers
// =====================
const windLayer = L.layerGroup().addTo(map);
const waveLayer = L.layerGroup().addTo(map);

L.control.layers(null,{
  "風向・風速": windLayer,
  "波高": waveLayer
}).addTo(map);

// =====================
// Utils
// =====================
const getArrowColor = s =>
  s>=20?"red":s>=15?"orange":s>=10?"yellow":"blue";

const getWaveColor = h =>
  h<0.5?"dodgerblue":
  h<1.0?"limegreen":
  h<1.5?"greenyellow":
  h<2.0?"gold":
  h<3.0?"darkorange":"orangered";

const windDirText = d => ({
  "南":0,"南南西":22.5,"南西":45,"西南西":67.5,
  "西":90,"西北西":112.5,"北西":135,"北北西":157.5,
  "北":180,"北北東":202.5,"北東":225,"東北東":247.5,
  "東":270,"東南東":292.5,"南東":315,"南南東":337.5
}[d] ?? null);

const windDir16 = d =>
  Number.isFinite(d) ? d * 22.5 + 180 : null;

// =====================
// Icons
// =====================
const makeWindIcon = (angle,speed,color)=>L.divIcon({
  className:"",
  iconSize:[48,48],
  iconAnchor:[24,24],
  html:`
  <div style="position:relative;width:48px;height:48px">
    <svg width="48" height="48" viewBox="0 0 48 48"
      style="transform:rotate(${angle}deg)">
      <polygon points="24,2 28,10 24,8 20,10" fill="${color}"/>
      <line x1="24" y1="2" x2="24" y2="28"
        stroke="${color}" stroke-width="2"/>
    </svg>
    <div class="wind-speed-label">${speed}</div>
  </div>`
});

// =====================
// ① 海上保安庁（風＋波）
// =====================
async function fetchKaiho(){
  const url = proxy + encodeURIComponent(
    "https://www6.kaiho.mlit.go.jp/micsgis/KishouGenkyouPoint/attribute"+
    "?lon=135&lat=35&stlon=120&stlat=20&edlon=150&edlat=50"
  );
  const data = await fetch(url).then(r=>r.json());

  data.forEach(e=>{
    if(!e.shp) return;
    const m=e.shp.match(/POINT\(([-\d.]+)\s+([-\d.]+)\)/);
    if(!m) return;

    const lon=Number(m[1]);
    const lat=Number(m[2]);

    // ---- wind ----
    const angle = windDirText(e.fuukou);
    const speed = Number(e.fuusoku);

    if (angle !== null && Number.isFinite(speed)) {
      L.marker([lat,lon],{
        icon:makeWindIcon(angle, speed, getArrowColor(speed))
      }).addTo(windLayer)
       .bindPopup(`${e.kansokujo_mei}<br>風速 ${speed} m/s`);
    }

    // ---- wave ----
    const h = Number(e.hakou);
    if (Number.isFinite(h)) {
      L.circleMarker([lat,lon],{
        radius:8,
        color:getWaveColor(h),
        fillColor:getWaveColor(h),
        fillOpacity:0.8
      }).addTo(waveLayer)
       .bindTooltip(`${e.kansokujo_mei}<br>${h.toFixed(2)} m`);
    }
  });
}

// =====================
// ② AMeDAS（風）
// =====================
function getAmedasTime(){
  const d=new Date();
  d.setMinutes(d.getMinutes()-10);
  d.setMinutes(Math.floor(d.getMinutes()/10)*10);
  const p=n=>n.toString().padStart(2,"0");
  return d.getFullYear()+p(d.getMonth()+1)+p(d.getDate())+
         p(d.getHours())+p(d.getMinutes())+"00";
}

async function fetchAmedas(){
  const t=getAmedasTime();
  const [data,meta]=await Promise.all([
    fetch(`https://www.jma.go.jp/bosai/amedas/data/map/${t}.json`).then(r=>r.json()),
    fetch("https://www.jma.go.jp/bosai/amedas/const/amedastable.json").then(r=>r.json())
  ]);

  Object.keys(data).forEach(c=>{
    const o=data[c];
    const m=meta[c];
    if(!m) return;

    const speed = Number(o.wind?.[0]);
    const dir   = Number(o.windDirection?.[0]);

    if (!Number.isFinite(speed) || !Number.isFinite(dir)) return;
    if (speed < 10) return;

    const angle = windDir16(dir);
    if (angle === null) return;

    const lat=m.lat[0]+m.lat[1]/60;
    const lon=m.lon[0]+m.lon[1]/60;

    L.marker([lat,lon],{
      icon:makeWindIcon(angle, speed.toFixed(1), getArrowColor(speed))
    }).addTo(windLayer)
     .bindPopup(`${m.kjName}<br>${speed} m/s`);
  });
}

// =====================
// ③ NOAA 船舶（風＋波）
// =====================
async function fetchNOAA(){
  const txt = await fetch(
    proxy + encodeURIComponent(
      "https://www.ndbc.noaa.gov/ship_obs.php?uom=M&time=2"
    )
  ).then(r=>r.text());

  (txt.match(/<span>SHIP.*?<\/span>/g)||[]).forEach(s=>{
    const p=s.replace(/<[^>]+>/g,"").trim().split(/\s+/);
    if(p.length<8) return;

    const lat  = Number(p[2]);
    const lon  = Number(p[3]);
    const wdir = Number(p[4]);
    const wspd = Number(p[5]);
    const wv   = Number(p[7]) * 0.3048;

    if(!Number.isFinite(lat)||!Number.isFinite(lon)) return;
    if (lon < 90 || lon > 180 || lat < 15 || lat > 60) return;
    
    if (Number.isFinite(wdir) && Number.isFinite(wspd)) {
      L.marker([lat,lon],{
        icon:makeWindIcon(wdir, wspd.toFixed(1), getArrowColor(wspd))
      }).addTo(windLayer);
    }

    if (Number.isFinite(wv)) {
      L.circleMarker([lat,lon],{
        radius:7,
        color:getWaveColor(wv),
        fillColor:getWaveColor(wv),
        fillOpacity:0.7
      }).addTo(waveLayer)
       .bindTooltip(`Ship<br>${wv.toFixed(2)} m`);
    }
  });
}

// =====================
// Init
// =====================
(async()=>{
  await Promise.all([
    fetchKaiho(),
    fetchAmedas(),
    fetchNOAA()
  ]);
})();
</script>
</body>
</html>
