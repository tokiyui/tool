<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>風・波統合マップ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html, body { margin:0; height:100%; }
#map { height:100vh; width:100vw; }

.wind-speed-label {
  font-size: 18px;
  font-weight: bold;
  color: black;
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  pointer-events: none;
}

.leaflet-div-icon {
  background: none;
  border: none;
  pointer-events: auto;
}

.legend {
  background: white;
  padding: 6px 8px;
  font-size: 14px;
  line-height: 18px;
  color: #333;
}

.legend i {
  width: 18px;
  height: 18px;
  float: left;
  margin-right: 6px;
  opacity: 0.8;
}

</style>
</head>

<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const map = L.map("map").setView([36,138],5);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{
  attribution:"&copy; OpenStreetMap contributors"
}).addTo(map);

const proxy = "https://corsproxy.io/?";

// ---------------- 共通関数 ----------------
const getArrowColor = s => s>=20?"red":s>=15?"orange":s>=10?"yellow":"blue";
const windDirToAngleText = dir => ({
 "南":0,"南南西":22.5,"南西":45,"西南西":67.5,
 "西":90,"西北西":112.5,"北西":135,"北北西":157.5,
 "北":180,"北北東":202.5,"北東":225,"東北東":247.5,
 "東":270,"東南東":292.5,"南東":315,"南南東":337.5
}[dir] ?? null);

const windDir16ToAngle = d => (d>=0&&d<=16)?d*22.5+180:null;

const makeWindIcon = (angle,speed,color)=>L.divIcon({
  html:`<div style="position:relative;width:48px;height:48px;">
    <svg width="48" height="48" viewBox="0 0 48 48" style="transform:rotate(${angle}deg);position:absolute;">
      <polygon points="24,2 28,10 24,8 20,10" fill="${color}"/>
      <line x1="24" y1="2" x2="24" y2="28" stroke="${color}" stroke-width="2"/>
    </svg>
    <div class="wind-speed-label">${speed}</div>
  </div>`,
  iconSize:[48,48], iconAnchor:[24,24]
});

const getColor = h=>{
 if(h<0.5)return"dodgerblue";
 if(h<1.0)return"limegreen";
 if(h<1.5)return"greenyellow";
 if(h<2.0)return"gold";
 if(h<3.0)return"darkorange";
 return"orangered";
};

const createCircleMarker=(lat,lon,color,html)=>
 L.circleMarker([lat,lon],{
   radius:8,color,fillColor:color,
   fillOpacity:0.8,weight:1
 }).bindTooltip(html,{sticky:true}).addTo(map);

// ---------------- 統合用データ ----------------
const pointData = {};
const pointKey = (lat, lon) => `${lat.toFixed(3)},${lon.toFixed(3)}`;

// ---------------- ①～⑤ fetch / async 処理をまとめる ----------------
async function fetchAllData(){
  // 海保風
  const kaiho = fetch(proxy+encodeURIComponent(
   "https://www6.kaiho.mlit.go.jp/micsgis/KishouGenkyouPoint/attribute"+
   "?lon=135&lat=35&stlon=105&stlat=20&edlon=165&edlat=50"
  )).then(r=>r.json()).then(data=>{
   data.forEach(e=>{
    if(!e.shp) return;
    const m=e.shp.match(/POINT\(([-\d.]+)\s+([-\d.]+)\)/);
    if(!m) return;
    const lon=+m[1], lat=+m[2];
    const a = windDirToAngleText(e.fuukou);
    const s = parseFloat(e.fuusoku);
    if(a===null||isNaN(s)) return;

    const key = pointKey(lat, lon);
    if(!pointData[key]) pointData[key] = { lat, lon };
    pointData[key].windHtml = `<b>風 (海保)</b><br><a href="${e.url}" target="_blank">${e.kansokujo_mei}</a>`;
    pointData[key].iconAngle = a;
    pointData[key].iconSpeed = s;
    pointData[key].iconColor = getArrowColor(s);
   });
  });

  // AMeDAS 風
  const timeStr=(()=>{
   const d=new Date();
   d.setMinutes(d.getMinutes()-10);
   d.setMinutes(Math.floor(d.getMinutes()/10)*10);
   return d.getFullYear()
   +String(d.getMonth()+1).padStart(2,"0")
   +String(d.getDate()).padStart(2,"0")
   +String(d.getHours()).padStart(2,"0")
   +String(d.getMinutes()).padStart(2,"0")+"00";
  })();
  const amedas = Promise.all([
    fetch(`https://www.jma.go.jp/bosai/amedas/data/map/${timeStr}.json`).then(r=>r.json()),
    fetch("https://www.jma.go.jp/bosai/amedas/const/amedastable.json").then(r=>r.json())
  ]).then(([amedas,table])=>{
    Object.keys(amedas).forEach(code=>{
      const o=amedas[code], m=table[code];
      if(!m) return;
      const s=o.wind?.[0], d=o.windDirection?.[0];
      if(s==null||d==null||s<10) return;
      const ang=windDir16ToAngle(d);
      if(ang===null) return;
      const lat=m.lat[0]+m.lat[1]/60;
      const lon=m.lon[0]+m.lon[1]/60;
      const key = pointKey(lat, lon);
      if(!pointData[key]) pointData[key] = { lat, lon };
      pointData[key].windHtml = `<b>風 (AMeDAS)</b><br><a href="https://www.jma.go.jp/bosai/amedas/#amdno=${code}" target="_blank">${m.kjName}</a>`;
      pointData[key].iconAngle = ang;
      pointData[key].iconSpeed = s.toFixed(1);
      pointData[key].iconColor = getArrowColor(s);
    });
  });

  // TODO: NOAA・NOWPHAS・河川局も同じく Promise 化（省略）

  await Promise.all([kaiho, amedas /*, NOAA, NOWPHAS, 河川 */]);

  // データ揃ったら描画
  drawPoints();
}

// ---------------- ⑥ 描画 ----------------
function drawPoints(){
  Object.values(pointData).forEach(p=>{
    let htmlParts = [];
    if(p.windHtml) htmlParts.push(p.windHtml);
    if(p.waveHtml) htmlParts.push(p.waveHtml);
    if(p.iconAngle != null){
      htmlParts.push(`風向: ${p.iconAngle}°`);
      htmlParts.push(`風速: ${p.iconSpeed} m/s`);
    }
    if(p.waveHeight != null){
      htmlParts.push(`波高: ${p.waveHeight.toFixed(2)} m`);
    }
    const html = htmlParts.join("<br>");

    // 風マーカー
    if(p.iconAngle != null){
      L.marker([p.lat,p.lon],{
        icon: makeWindIcon(p.iconAngle,p.iconSpeed,p.iconColor)
      }).bindPopup(html,{maxWidth:300,autoClose:false,closeOnClick:false}).addTo(map);
    }

    // 波マーカー
    if(p.waveHeight != null){
      L.circleMarker([p.lat,p.lon],{
        radius:8,
        color:getColor(p.waveHeight),
        fillColor:getColor(p.waveHeight),
        fillOpacity:0.8,
        weight:1
      }).bindPopup(html,{maxWidth:300,autoClose:false,closeOnClick:false}).addTo(map);
    }
  });
}

// ---------------- ⑦ 凡例 ----------------
const legend=L.control({position:"bottomright"});
legend.onAdd=function(){
 const d=L.DomUtil.create("div","legend");
 const g=[0,0.5,1,1.5,2,3];
 d.innerHTML+="<b>波高 (m)</b><br>";
 for(let i=0;i<g.length;i++){
  d.innerHTML+=`<i style="background:${getColor(g[i]+0.01)}"></i>${g[i]}${g[i+1]?"–"+g[i+1]:"+"}<br>`;
 }
 return d;
};
legend.addTo(map);

// ---------------- 実行 ----------------
fetchAllData();

</script>
</body>
</html>
