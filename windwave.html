<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>風・波 統合マップ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html, body { margin:0; height:100%; }
#map { height:100vh; }

.wind-speed-label {
  font-size:14px;
  font-weight:bold;
  color:black;
  text-shadow:1px 1px 2px white;
  position:absolute;
  top:50%; left:50%;
  transform:translate(-50%,-50%);
  pointer-events:none;
}

.legend {
  background:white;
  padding:6px 8px;
  font-size:13px;
}
.legend i {
  width:18px;
  height:18px;
  float:left;
  margin-right:6px;
  opacity:0.8;
}
</style>
</head>

<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/* =========================
   MAP
========================= */
const map = L.map("map").setView([36,138],5);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{
  attribution:"&copy; OpenStreetMap contributors"
}).addTo(map);

const proxy = "https://corsproxy.io/?";

/* =========================
   LAYERS
========================= */
const windLayer = L.layerGroup().addTo(map);
const waveLayer = L.layerGroup().addTo(map);

/* =========================
   UTIL
========================= */
const getArrowColor = s =>
  s>=20?"red":s>=15?"orange":s>=10?"yellow":"blue";

const getWaveColor = h =>
  h<0.5?"dodgerblue":
  h<1.0?"limegreen":
  h<1.5?"greenyellow":
  h<2.0?"gold":
  h<3.0?"darkorange":"orangered";

const windDirText = d => ({
  "南":0,"南南西":22.5,"南西":45,"西南西":67.5,
  "西":90,"西北西":112.5,"北西":135,"北北西":157.5,
  "北":180,"北北東":202.5,"北東":225,"東北東":247.5,
  "東":270,"東南東":292.5,"南東":315,"南南東":337.5
}[d] ?? null);

const windDir16 = d => (d>=0&&d<=16)?d*22.5+180:null;

const makeWindIcon = (angle,speed,color)=>L.divIcon({
  className:"",
  html:`
  <div style="width:48px;height:48px;position:relative">
    <svg width="48" height="48"
      style="transform:rotate(${angle}deg)">
      <polygon points="24,2 28,10 24,8 20,10" fill="${color}"/>
      <line x1="24" y1="2" x2="24" y2="28"
        stroke="${color}" stroke-width="2"/>
    </svg>
    <div class="wind-speed-label">${speed}</div>
  </div>`,
  iconSize:[48,48],
  iconAnchor:[24,24]
});

/* =========================
   ① 海上保安庁 風
========================= */
fetch(proxy+encodeURIComponent(
"https://www6.kaiho.mlit.go.jp/micsgis/KishouGenkyouPoint/attribute"+
"?lon=135&lat=35&stlon=90&stlat=15&edlon=180&edlat=60"
))
.then(r=>r.json())
.then(d=>{
  d.forEach(e=>{
    if(!e.shp) return;
    const m=e.shp.match(/POINT\(([-\d.]+) ([-\d.]+)\)/);
    if(!m) return;
    const lat=Number(m[2]), lon=Number(m[1]);
    const sp=Number(e.fuusoku);
    const ang=windDirText(e.fuukou);
    if(!Number.isFinite(sp)||ang===null) return;
    L.marker([lat,lon],{
      icon:makeWindIcon(ang,sp,getArrowColor(sp))
    }).addTo(windLayer);
  });
});

/* =========================
   ② AMeDAS 風
========================= */
const amTime=(()=>{
  const d=new Date();
  d.setMinutes(d.getMinutes()-10);
  d.setMinutes(Math.floor(d.getMinutes()/10)*10);
  return d.toISOString().slice(0,16).replace(/[-T:]/g,"")+"00";
})();

Promise.all([
  fetch(`https://www.jma.go.jp/bosai/amedas/data/map/${amTime}.json`).then(r=>r.json()),
  fetch("https://www.jma.go.jp/bosai/amedas/const/amedastable.json").then(r=>r.json())
]).then(([a,t])=>{
  Object.keys(a).forEach(c=>{
    const o=a[c], m=t[c];
    const sp=Number(o.wind?.[0]);
    const d=Number(o.windDirection?.[0]);
    if(!Number.isFinite(sp)||sp<10||!Number.isFinite(d)) return;
    const ang=windDir16(d);
    if(ang===null) return;
    const lat=m.lat[0]+m.lat[1]/60;
    const lon=m.lon[0]+m.lon[1]/60;
    L.marker([lat,lon],{
      icon:makeWindIcon(ang,sp.toFixed(1),getArrowColor(sp))
    }).addTo(windLayer);
  });
});

/* =========================
   ③ NOAA 船舶 風・波
========================= */
fetch(proxy+encodeURIComponent(
"https://www.ndbc.noaa.gov/ship_obs.php?uom=M&time=2"
))
.then(r=>r.text())
.then(txt=>{
  (txt.match(/<span>SHIP.*?<\/span>/g)||[]).forEach(s=>{
    const p=s.replace(/<[^>]+>/g,"").trim().split(/\s+/);
    if(p.length<8) return;
    const lat=Number(p[2]), lon=Number(p[3]);
    const wd=Number(p[4]), ws=Number(p[5]);
    const wh=Number(p[7])*0.3048;
    if(!Number.isFinite(lat)||!Number.isFinite(lon)) return;
    if(lat<15||lat>60||lon<90||lon>180) return;

    if(Number.isFinite(ws)&&Number.isFinite(wd)){
      L.marker([lat,lon],{
        icon:makeWindIcon(wd,ws.toFixed(1),getArrowColor(ws))
      }).addTo(windLayer);
    }
    if(Number.isFinite(wh)){
      L.circleMarker([lat,lon],{
        radius:7,color:getWaveColor(wh),
        fillColor:getWaveColor(wh),fillOpacity:0.7
      }).addTo(waveLayer)
      .bindTooltip(`Ship ${wh.toFixed(2)} m`);
    }
  });
});

/* =========================
   波高 凡例
========================= */
const legend=L.control({position:"bottomright"});
legend.onAdd=()=>{
  const d=L.DomUtil.create("div","legend");
  const g=[0,0.5,1,1.5,2,3];
  d.innerHTML="<b>波高 (m)</b><br>";
  for(let i=0;i<g.length;i++){
    d.innerHTML+=
      `<i style="background:${getWaveColor(g[i]+0.01)}"></i>
       ${g[i]}${g[i+1]?"–"+g[i+1]:"+"}<br>`;
  }
  return d;
};
legend.addTo(map);
</script>
</body>
</html>
