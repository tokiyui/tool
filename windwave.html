<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>波高＋風向 監視マップ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html, body { margin:0; height:100%; }
#map { height:100vh; width:100vw; }

.legend {
  background:white;
  padding:6px 8px;
  font-size:14px;
}

.wind-speed-label {
  font-size:16px;
  font-weight:bold;
  color:black;
  text-shadow:1px 1px 2px white;
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  pointer-events:none;
}
</style>
</head>

<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// ======================================
// 共通設定
// ======================================
const map = L.map("map").setView([36,138], 5);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution:"&copy; OpenStreetMap contributors"
}).addTo(map);

const proxy = "https://corsproxy.io/?";

// ======================================
// 波高用
// ======================================
const getWaveColor = h =>
  h<0.5?"dodgerblue":
  h<1.0?"limegreen":
  h<1.5?"greenyellow":
  h<2.0?"gold":
  h<3.0?"darkorange":"orangered";

const addWaveMarker = (lat,lon,color,html)=>
  L.circleMarker([lat,lon],{
    radius:8,color,fillColor:color,fillOpacity:0.8
  }).bindTooltip(html).addTo(map);

// ======================================
// 風向用
// ======================================
const getArrowColor = s =>
  s>=20?"red":s>=15?"orange":s>=10?"yellow":"blue";

const makeWindIcon = (angle,speed,color)=>L.divIcon({
  className:"",
  html:`
  <div style="width:48px;height:48px;position:relative">
    <svg width="48" height="48"
         style="transform:rotate(${angle}deg)">
      <polygon points="24,2 28,10 24,8 20,10" fill="${color}"/>
      <line x1="24" y1="2" x2="24" y2="28"
            stroke="${color}" stroke-width="2"/>
    </svg>
    <div class="wind-speed-label">${speed}</div>
  </div>`,
  iconSize:[48,48],
  iconAnchor:[24,24]
});

// ======================================
// NOWPHAS 波高
// ======================================
(async()=>{
const setupXML = await fetch(proxy+
  encodeURIComponent("https://nowphas.mlit.go.jp/PROG/xml/POINT_SETUP.xml"))
  .then(r=>r.text()).then(t=>new DOMParser().parseFromString(t,"text/xml"));

const dataXML = await fetch(proxy+
  encodeURIComponent("https://nowphas.mlit.go.jp/mapxml/DataMap.xml"))
  .then(r=>r.text()).then(t=>new DOMParser().parseFromString(t,"text/xml"));

const points={};
setupXML.querySelectorAll("point").forEach(p=>{
  points[p.getAttribute("code")] = {
    name:p.getAttribute("name"),
    lat:+p.getAttribute("lat"),
    lon:+p.getAttribute("lon")
  };
});

dataXML.querySelectorAll("mapdata").forEach(md=>{
  const code = md.getAttribute("code");
  const h = parseFloat(md.querySelector("yugiha")?.textContent);
  if(!points[code]||isNaN(h)||h>50) return;

  addWaveMarker(
    points[code].lat,
    points[code].lon,
    getWaveColor(h),
    `<a href="https://nowphas.mlit.go.jp/yugiha_graph/${code}/7/"
        target="_blank">${points[code].name}</a><br>
     (${h.toFixed(2)} m)`
  );
});
})();

// ======================================
// 海保 風向
// ======================================
fetch(proxy + encodeURIComponent(URL))
  .then(r => r.text())
  .then(txt => {
    console.log(txt);
  });
fetch(proxy+encodeURIComponent(
 "https://www6.kaiho.mlit.go.jp/micsgis/KishouGenkyouPoint/attribute"+
 "?stlon=120&stlat=20&edlon=150&edlat=50"))
.then(r=>r.json())
.then(data=>{
  data.forEach(e=>{
    if(!e.shp||!e.fuusoku||!e.fuukou) return;
    const m=e.shp.match(/POINT\(([-\d.]+) ([-\d.]+)\)/);
    if(!m) return;

    const icon=makeWindIcon(
      {"北":180,"南":0,"東":270,"西":90}[e.fuukou]??0,
      parseFloat(e.fuusoku),
      getArrowColor(e.fuusoku)
    );

    L.marker([+m[2],+m[1]],{icon}).addTo(map)
     .bindPopup(`<b>${e.kansokujo_mei}</b><br>風速:${e.fuusoku}`);
  });
});

// ======================================
// 凡例
// ======================================
const legend=L.control({position:"bottomright"});
legend.onAdd=()=>{
  const d=L.DomUtil.create("div","legend");
  d.innerHTML="<b>波高(m)</b><br>"+
    [0,0.5,1,1.5,2,3].map(v=>
      `<i style="background:${getWaveColor(v+0.01)};
      width:18px;height:18px;display:inline-block"></i> ${v}`).join("<br>");
  return d;
};
legend.addTo(map);
</script>
</body>
</html>
