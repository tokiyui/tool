<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>波高＋風向 統合マップ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet"
 href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html, body { margin:0; height:100%; }
#map { height:100vh; width:100vw; }

.wind-speed {
  position:absolute;
  top:50%; left:50%;
  transform:translate(-50%,-50%);
  font-size:16px;
  font-weight:bold;
  color:black;
  text-shadow:1px 1px 2px white;
  pointer-events:none;
}
.legend {
  background:white;
  padding:6px 8px;
  font-size:13px;
}
.legend i {
  width:18px;
  height:18px;
  float:left;
  margin-right:6px;
}
</style>
</head>

<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// ===================================================
// 地図
// ===================================================
const map = L.map("map").setView([36,138],5);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{
  attribution:"&copy; OpenStreetMap"
}).addTo(map);

const waveLayer = L.layerGroup().addTo(map);
const windLayer = L.layerGroup().addTo(map);

// ===================================================
// 共通
// ===================================================
const proxy = "https://corsproxy.io/?";

const getColor = h =>
  h<0.5?"dodgerblue":
  h<1.0?"limegreen":
  h<1.5?"greenyellow":
  h<2.0?"gold":
  h<3.0?"darkorange":"orangered";

const getArrowColor = s =>
  s>=20?"red":s>=15?"orange":s>=10?"yellow":"blue";

const windDirText = d => ({
 "南":0,"南南西":22.5,"南西":45,"西南西":67.5,
 "西":90,"西北西":112.5,"北西":135,"北北西":157.5,
 "北":180,"北北東":202.5,"北東":225,"東北東":247.5,
 "東":270,"東南東":292.5,"南東":315,"南南東":337.5
}[d] ?? null);

const makeWindIcon = (angle,speed,color)=>L.divIcon({
 className:"",
 html:`
 <div style="position:relative;width:48px;height:48px">
  <svg width="48" height="48"
   style="transform:rotate(${angle}deg)">
   <polygon points="24,2 28,10 24,8 20,10" fill="${color}"/>
   <line x1="24" y1="2" x2="24" y2="28"
    stroke="${color}" stroke-width="2"/>
  </svg>
  <div class="wind-speed">${speed}</div>
 </div>`,
 iconSize:[48,48],
 iconAnchor:[24,24]
});

// ===================================================
// 安全 fetch（JSON崩壊対策）
// ===================================================
async function safeFetchJSON(url){
  const r = await fetch(url);
  const t = await r.text();
  if(!t || t.length<5) return null;
  try { return JSON.parse(t); }
  catch { return null; }
}

// ===================================================
// ① 海上保安庁（波高＋風向）【1回取得】
// ===================================================
(async()=>{
  const url =
   "https://www6.kaiho.mlit.go.jp/micsgis/KishouGenkyouPoint/attribute"+
   "?stlon=120&stlat=20&edlon=150&edlat=50";

  const data = await safeFetchJSON(
    proxy+encodeURIComponent(url)
  );
  if(!Array.isArray(data)) return;

  data.forEach(e=>{
    if(!e.shp) return;
    const m = e.shp.match(/POINT\(([-\d.]+)\s+([-\d.]+)\)/);
    if(!m) return;

    const lon=+m[1], lat=+m[2];
    if(lat<20||lat>50||lon<120||lon>150) return;

    // --- 波高 ---
    if(e.hakou){
      const h=parseFloat(e.hakou);
      if(!isNaN(h)){
        L.circleMarker([lat,lon],{
          radius:8,
          color:getColor(h),
          fillColor:getColor(h),
          fillOpacity:0.8
        }).bindTooltip(
          `${e.kansokujo_mei}<br>波高 ${h.toFixed(2)}m`
        ).addTo(waveLayer);
      }
    }

    // --- 風向 ---
    const angle=windDirText(e.fuukou);
    const speed=parseFloat(e.fuusoku);
    if(angle!=null&&!isNaN(speed)){
      L.marker([lat,lon],{
        icon:makeWindIcon(angle,speed,getArrowColor(speed))
      }).bindPopup(
        `${e.kansokujo_mei}<br>
         風向:${e.fuukou}<br>
         風速:${e.fuusoku}`
      ).addTo(windLayer);
    }
  });
})();

// ===================================================
// ② NOAA 船舶（1回取得で波＋風）
// ===================================================
(async()=>{
 const url="https://www.ndbc.noaa.gov/ship_obs.php?uom=M&time=2";
 const t=await fetch(proxy+encodeURIComponent(url)).then(r=>r.text());
 t.split("\n").forEach(l=>{
  if(!l.includes("SHIP")) return;
  const c=l.replace(/<[^>]+>/g,"").trim().split(/\s+/);
  if(c.length<8) return;

  const lat=+c[2], lon=+c[3],
        dir=+c[4], spd=+c[5], wv=+c[7];

  if(lat<20||lat>50||lon<120||lon>150) return;

  if(!isNaN(wv)){
    const h=wv*0.3048;
    L.circleMarker([lat,lon],{
      radius:7,color:getColor(h),
      fillColor:getColor(h),fillOpacity:0.8
    }).bindTooltip(`SHIP 波高 ${h.toFixed(2)}m`)
     .addTo(waveLayer);
  }

  if(!isNaN(dir)&&!isNaN(spd)){
    L.marker([lat,lon],{
      icon:makeWindIcon(dir,spd,getArrowColor(spd))
    }).addTo(windLayer);
  }
 });
})();

// ===================================================
// 凡例
// ===================================================
const legend=L.control({position:"bottomright"});
legend.onAdd=()=>{
 const d=L.DomUtil.create("div","legend");
 d.innerHTML="<b>波高(m)</b><br>";
 [0,0.5,1,1.5,2,3].forEach(v=>{
  d.innerHTML+=`<i style="background:${getColor(v+0.01)}"></i>${v}<br>`;
 });
 return d;
};
legend.addTo(map);
</script>
</body>
</html>
