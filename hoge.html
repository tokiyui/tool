<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>最新NCファイル取得デバッグ（PyScript modern syntax）</title>

<!-- PyScript: pin to specific current version (avoid /latest; deprecation noted) -->
<link rel="stylesheet" href="https://pyscript.net/releases/2025.10.1/core.css">
<script type="module" src="https://pyscript.net/releases/2025.10.1/core.js"></script>

<style>
  body { font-family: sans-serif; padding: 20px; }
  #status { margin-top: 5px; white-space: pre-wrap; font-family: monospace; }
  button { margin-top: 10px; padding: 6px 12px; }
</style>
</head>
<body>

<h2>最新NCファイル取得デバッグ（global_vavh形式）</h2>

<button id="fetchBtn">JSで最新ファイル取得</button>
<div id="status"></div>

<script>
const PROXY = "https://worker.ryohorita105.workers.dev/?url=";
const BASE  = "https://data.marine.copernicus.eu/product/WAVE_GLO_PHY_SWH_L3_NRT_014_001/files?path=WAVE_GLO_PHY_SWH_L3_NRT_014_001/global_vavh_l3_rt_cfo_";

function getLatestTime() {
    const now = new Date();
    const utcNow = new Date(now.getTime() + now.getTimezoneOffset() * 60000);
    const minus6 = new Date(utcNow.getTime() - 6*60*60*1000);
    const hour = Math.floor(minus6.getUTCHours()/3)*3;
    const latest = new Date(Date.UTC(minus6.getUTCFullYear(), minus6.getUTCMonth(), minus6.getUTCDate(), hour));
    const y = latest.getUTCFullYear();
    const m = String(latest.getUTCMonth()+1).padStart(2,'0');
    const d = String(latest.getUTCDate()).padStart(2,'0');
    const H = String(latest.getUTCHours()).padStart(2,'0');
    return { YYYYMMDDTHHMMSS: `${y}${m}${d}T${H}0000`, y, m, d };
}

async function fetchLatestNC() {
    const t = getLatestTime();
    const dirUrl = `${PROXY}${BASE}${t.y}/${t.m}/${t.d}/`;
    const status = document.getElementById("status");
    status.innerText = `[JS] ディレクトリURL: ${dirUrl}\n取得中...`;

    try {
        const resp = await fetch(dirUrl);
        status.innerText += `\n[JS] ディレクトリHTTPステータス: ${resp.status}`;
        if (!resp.ok) throw new Error(`HTTP error ${resp.status}`);
        const html = await resp.text();
        status.innerText += `\n[JS] HTML length: ${html.length}`;

        const regex = new RegExp(`global_vavh_l3_rt_cfo_${t.YYYYMMDDTHHMMSS}_[^<"\\s]+\\.nc`, "g");
        const matches = html.match(regex);
        status.innerText += `\n[JS] Matches: ${matches ? matches.length : 0}`;
        if (!matches || !matches.length) throw new Error("ファイルが見つかりません");

        const latestFile = matches[0];
        status.innerText += `\n[JS] Found file: ${latestFile}\nFetching...`;

        const fileResp = await fetch(`${PROXY}${BASE}${t.y}/${t.m}/${t.d}/${latestFile}`);
        status.innerText += `\n[JS] File HTTP status: ${fileResp.status}`;
        if (!fileResp.ok) throw new Error(`HTTP error ${fileResp.status}`);
        const blob = await fileResp.blob();
        status.innerText += `\n[JS] File size: ${blob.size} bytes`;
    } catch (err) {
        status.innerText += `\n[JS] Error: ${err}`;
    }
}

document.getElementById("fetchBtn").addEventListener("click", fetchLatestNC);
</script>

<script type="py">
import asyncio, datetime, re
from pyodide.http import pyfetch
from pyscript import display

async def fetch_nc_py():
    out = ""
    now = datetime.datetime.utcnow()
    minus6 = now - datetime.timedelta(hours=6)
    hour = (minus6.hour // 3) * 3
    latest = datetime.datetime(minus6.year, minus6.month, minus6.day, hour)
    key = latest.strftime("%Y%m%dT%H0000")

    dirUrl = f"{PROXY}{BASE}{latest.year:04d}/{latest.month:02d}/{latest.day:02d}/"
    out += f"[PyScript] Dir URL: {dirUrl}\n"

    try:
        resp = await pyfetch(dirUrl)
        out += f"[PyScript] Dir HTTP: {resp.status}\n"
        html = await resp.string()
        out += f"[PyScript] HTML length: {len(html)}\n"

        regex = re.compile(f"global_vavh_l3_rt_cfo_{key}_[^<\"'\\s]+\\.nc")
        matches = regex.findall(html)
        out += f"[PyScript] Matches: {len(matches)}\n"
        if not matches:
            raise RuntimeError("ファイルが見つかりません")

        latestFile = matches[0]
        out += f"[PyScript] File: {latestFile}\n"

        fileResp = await pyfetch(f"{PROXY}{BASE}{latest.year:04d}/{latest.month:02d}/{latest.day:02d}/{latestFile}")
        out += f"[PyScript] File HTTP: {fileResp.status}\n"
        data = await fileResp.bytes()
        out += f"[PyScript] File size: {len(data)} bytes"
    except Exception as e:
        out += f"[PyScript] Error: {e}"

    display(out, target="status", append=True)

button = Element("status")  # hack: trigger once
</script>

</body>
</html>
