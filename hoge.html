<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>波高地図（衛星＋観測点 色整合）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100vh; width: 100vw; }

    .legend {
      background: white;
      padding: 6px 8px;
      font-size: 14px;
      line-height: 18px;
      color: #333;
    }
    .legend i {
      width: 18px;
      height: 18px;
      float: left;
      margin-right: 6px;
      opacity: 0.8;
    }
  </style>
</head>
<body>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/* =====================================================
   Map
===================================================== */
const map = L.map("map").setView([36, 138], 5);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "&copy; OpenStreetMap contributors",
  maxZoom: 8
}).addTo(map);

/* =====================================================
   時刻（UTC-6h → 3h切り捨て）
===================================================== */
function latestTimeISO() {
  const d = new Date();
  d.setUTCHours(d.getUTCHours() - 6);
  d.setUTCHours(Math.floor(d.getUTCHours() / 3) * 3, 0, 0, 0);
  return d.toISOString();
}
const timeISO = latestTimeISO();

/* =====================================================
   Copernicus WMS（衛星SWH）
===================================================== */
const WMS_URL =
  "https://nrt.cmems-du.eu/thredds/wms/" +
  "cmems_obs-wave_glo_phy-swh_nrt_cfo-l3_PT1S_202211";

function addSWHLayer(min, max) {
  return L.tileLayer.wms(WMS_URL, {
    layers: "VAVH",
    styles: "boxfill",
    format: "image/png",
    transparent: true,
    time: timeISO,
    colorscalerange: `${min},${max}`,
    numcolorbands: 1,
    belowmincolor: "transparent",
    abovemaxcolor: "transparent",
    opacity: 0.55
  }).addTo(map);
}

// 観測点と完全一致の色分け
addSWHLayer(0.0, 0.5);  // dodgerblue
addSWHLayer(0.5, 1.0);  // limegreen
addSWHLayer(1.0, 1.5);  // greenyellow
addSWHLayer(1.5, 2.0);  // gold
addSWHLayer(2.0, 3.0);  // darkorange
addSWHLayer(3.0, 8.0);  // orangered

/* =====================================================
   観測点 共通関数
===================================================== */
const proxy = "https://worker.ryohorita105.workers.dev/?url=";

function getColor(h) {
  if (h < 0.5) return "dodgerblue";
  if (h < 1.0) return "limegreen";
  if (h < 1.5) return "greenyellow";
  if (h < 2.0) return "gold";
  if (h < 3.0) return "darkorange";
  return "orangered";
}

function createCircleMarker(lat, lon, color, text) {
  return L.circleMarker([lat, lon], {
    radius: 7,
    color,
    fillColor: color,
    fillOpacity: 0.85,
    weight: 1
  }).bindTooltip(text).addTo(map);
}

async function fetchJSON(url) {
  const r = await fetch(url);
  return await r.json();
}
async function fetchXML(url) {
  const r = await fetch(url);
  const t = await r.text();
  return new DOMParser().parseFromString(t, "application/xml");
}
async function fetchText(url) {
  const r = await fetch(url);
  return await r.text();
}

/* =====================================================
   観測点プロット
===================================================== */
async function plotWaveData() {
  // --- NOWPHAS ---
  const setupXML = await fetchXML(proxy + encodeURIComponent(
    "https://nowphas.mlit.go.jp/PROG/xml/POINT_SETUP.xml"
  ));
  const dataXML = await fetchXML(proxy + encodeURIComponent(
    "https://nowphas.mlit.go.jp/mapxml/DataMap.xml"
  ));

  const points = {};
  for (const pt of setupXML.getElementsByTagName("point")) {
    points[pt.getAttribute("code")] = {
      name: pt.getAttribute("name"),
      lat: +pt.getAttribute("lat"),
      lon: +pt.getAttribute("lon")
    };
  }

  for (const md of dataXML.getElementsByTagName("mapdata")) {
    const code = md.getAttribute("code");
    const el = md.getElementsByTagName("yugiha")[0];
    if (!el || !points[code]) continue;
    const h = parseFloat(el.textContent);
    if (h >= 100) continue;
    const p = points[code];
    createCircleMarker(p.lat, p.lon, getColor(h), `${p.name} (${h.toFixed(2)} m)`);
  }

  // --- JMA SSVB ---
  const ssvb = await fetchJSON("https://www.jma.go.jp/bosai/wave/data/ssvb/map_ssvb.json");
  const nowUTC = new Date();
  const sixHoursAgo = new Date(nowUTC.getTime() - 6 * 3600 * 1000);

  for (const id in ssvb) {
    const entries = ssvb[id];
    const times = Object.keys(entries)
      .filter(t => new Date(t) >= sixHoursAgo)
      .sort();
    if (!times.length) continue;
    const d = entries[times.at(-1)];
    if (!d.latlon) continue;
    createCircleMarker(
      d.latlon[0], d.latlon[1],
      getColor(d.wave_height),
      `Buoy (${d.wave_height.toFixed(2)} m)`
    );
  }
}

/* =====================================================
   凡例
===================================================== */
const legend = L.control({ position: "bottomright" });
legend.onAdd = function () {
  const div = L.DomUtil.create("div", "legend");
  const grades = [0,0.5,1,1.5,2,3];
  div.innerHTML += "<b>波高 (m)</b><br>";
  for (let i=0;i<grades.length;i++) {
    const from = grades[i];
    const to = grades[i+1];
    div.innerHTML +=
      `<i style="background:${getColor(from+0.01)}"></i>` +
      `${from}${to ? "–"+to : "+"}<br>`;
  }
  return div;
};
legend.addTo(map);

/* =====================================================
   実行
===================================================== */
plotWaveData().catch(e => {
  console.error(e);
  alert("データ取得エラー");
});
</script>

</body>
</html>
