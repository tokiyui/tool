<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>Copernicus SWH latest (ESM)</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
}
#map {
  width: 100%;
  height: 100%;
}
#info {
  position: absolute;
  top: 8px;
  left: 8px;
  z-index: 1000;
  background: rgba(255,255,255,0.9);
  padding: 6px 10px;
  font-family: monospace;
  font-size: 12px;
}
</style>
</head>
<body>

<div id="map"></div>
<div id="info">loading...</div>

<script type="module">
/* ==================================================
 * imports（ここが決定打）
 * ================================================== */
import { NetCDFReader } from "https://cdn.skypack.dev/netcdfjs";

/* ==================================================
 * CORS proxy
 * ================================================== */
const CORS_PROXY = "https://worker.ryohorita105.workers.dev/?url=";

/* ==================================================
 * 時刻計算（UTC-6h → 3時間切り捨て）
 * ================================================== */
function getLatestBaseTimeUTC() {
  const now = new Date();
  const utc = new Date(now.getTime() + now.getTimezoneOffset() * 60000);
  utc.setUTCHours(utc.getUTCHours() - 6);
  utc.setUTCHours(Math.floor(utc.getUTCHours() / 3) * 3, 0, 0, 0);
  return utc;
}

function fmt(dt) {
  const z = n => String(n).padStart(2, "0");
  return (
    dt.getUTCFullYear() +
    z(dt.getUTCMonth() + 1) +
    z(dt.getUTCDate()) +
    "T" +
    z(dt.getUTCHours()) +
    "0000"
  );
}

/* ==================================================
 * Copernicus URL
 * ================================================== */
function buildCopernicusURL(baseTime) {
  const y = baseTime.getUTCFullYear();
  const m = String(baseTime.getUTCMonth() + 1).padStart(2, "0");
  const t1 = fmt(baseTime);
  const t2 = fmt(new Date(baseTime.getTime() + 3 * 3600 * 1000));
  const t3 = fmt(new Date());

  return (
    "https://data.marine.copernicus.eu/product/WAVE_GLO_PHY_SWH_L3_NRT_014_001/files" +
    "?path=WAVE_GLO_PHY_SWH_L3_NRT_014_001/" +
    "cmems_obs-wave_glo_phy-swh_nrt_cfo-l3_PT1S_202211/" +
    y + "/" + m + "/" +
    "&subdataset=cmems_obs-wave_glo_phy-swh_nrt_cfo-l3_PT1S_202211_" +
    t1 + "_" + t2 + "_" + t3 + ".nc"
  );
}

/* ==================================================
 * NetCDF → Canvas
 * ================================================== */
async function loadAndRender(url) {
  const res = await fetch(CORS_PROXY + url);
  if (!res.ok) throw new Error("fetch failed");

  const buf = await res.arrayBuffer();
  const nc = new NetCDFReader(buf);

  const lon = nc.getDataVariable("longitude");
  const lat = nc.getDataVariable("latitude");
  const swh = nc.getDataVariable("VAVH"); // [time, lat, lon]

  const nx = lon.length;
  const ny = lat.length;

  const canvas = document.createElement("canvas");
  canvas.width = nx;
  canvas.height = ny;
  const ctx = canvas.getContext("2d");
  const img = ctx.createImageData(nx, ny);

  for (let j = 0; j < ny; j++) {
    for (let i = 0; i < nx; i++) {
      const v = swh[j * nx + i]; // time=0
      const p = ((ny - 1 - j) * nx + i) * 4;

      if (!isFinite(v)) {
        img.data[p + 3] = 0;
      } else {
        const c = Math.min(255, v / 8 * 255);
        img.data[p]     = c;
        img.data[p + 1] = c;
        img.data[p + 2] = 255;
        img.data[p + 3] = 180;
      }
    }
  }

  ctx.putImageData(img, 0, 0);

  return {
    canvas,
    bounds: [
      [lat[0], lon[0]],
      [lat[lat.length - 1], lon[lon.length - 1]]
    ]
  };
}

/* ==================================================
 * Leaflet
 * ================================================== */
const map = L.map("map").setView([0, 160], 2);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

const baseTime = getLatestBaseTimeUTC();
const url = buildCopernicusURL(baseTime);

document.getElementById("info").textContent =
  "fetching: " + fmt(baseTime) + " UTC";

try {
  const { canvas, bounds } = await loadAndRender(url);
  L.imageOverlay(canvas, bounds).addTo(map);
  document.getElementById("info").textContent =
    "SWH " + fmt(baseTime) + " UTC";
} catch (e) {
  document.getElementById("info").textContent = "ERROR";
  console.error(e);
}
</script>

</body>
</html>
