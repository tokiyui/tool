<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>PyScript CMEMS 最新NC取得</title>

<link rel="stylesheet" href="https://pyscript.net/releases/2025.10.1/core.css" />
<script type="module" src="https://pyscript.net/releases/2025.10.1/core.js"></script>

<style>
body { font-family: sans-serif; padding: 20px; }
#status { white-space: pre-wrap; font-family: monospace; margin-top: 10px; }
button { padding: 6px 12px; margin-top: 10px; }
</style>
</head>
<body>

<h2>PyScriptでCMEMS APIから最新NC取得</h2>

<div>
  <label>Username: <input id="username" type="text"></label><br>
  <label>Password: <input id="password" type="password"></label><br>
  <button id="fetchBtn">最新NC取得</button>
</div>

<div id="status"></div>

<script type="py">
import asyncio
import datetime
from pyscript import display
import micropip

async def fetch_latest_nc(username: str, password: str):
    out = ""
    try:
        out += "PyScript: motuclientをインストール中...\n"
        await micropip.install("motuclient")
        from motuclient import MotuClient

        # 最新時刻計算 (UTC-6h, 3時間単位)
        now = datetime.datetime.utcnow()
        minus6 = now - datetime.timedelta(hours=6)
        hour = (minus6.hour // 3) * 3
        latest = datetime.datetime(minus6.year, minus6.month, minus6.day, hour)

        start_time = latest.strftime("%Y-%m-%d %H:%M:%S")
        end_time   = (latest + datetime.timedelta(hours=3)).strftime("%Y-%m-%d %H:%M:%S")
        output_file = f"global_vavh_l3_rt_j3_{latest.strftime('%Y%m%dT%H%M%S')}.nc"

        out += f"取得範囲: {start_time} ～ {end_time}\n"
        out += f"出力ファイル名: {output_file}\n"

        # MOTU Client 設定
        motu = MotuClient(
            service_id='WAVE_GLO_PHY_SWH_L3_NRT_014_001',
            product_id='cmems_obs-wave_glo_phy-swh_nrt_j3-l3_PT1S_202211',
            date_min=start_time,
            date_max=end_time,
            depth_min='0.0',
            depth_max='0.0',
            longitude_min='-180',
            longitude_max='180',
            latitude_min='-90',
            latitude_max='90',
            variable=['swh'],
            out_dir='.',
            out_name=output_file,
            user=username,
            pwd=password,
            format='netcdf'
        )

        out += "PyScript: データ取得開始...\n"
        motu.download()
        out += f"取得完了: {output_file}\n"

    except Exception as e:
        out += f"エラー: {e}"

    display(out, target="status", append=True)

# ボタンイベント設定
from js import document
import pyodide

def on_click(e):
    username = document.getElementById("username").value
    password = document.getElementById("password").value
    asyncio.ensure_future(fetch_latest_nc(username, password))

document.getElementById("fetchBtn").addEventListener("click", pyodide.ffi.create_proxy(on_click))
</script>

</body>
</html>
