<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Copernicus fetch test</title>
</head>
<body>

<h3>Copernicus nc fetch test</h3>
<pre id="log">start...</pre>

<script>
const PROXY = "https://worker.ryohorita105.workers.dev/?url=";
const BASE =
  "https://data.marine.copernicus.eu/product/WAVE_GLO_PHY_SWH_L3_NRT_014_001/files?path=" +
  "WAVE_GLO_PHY_SWH_L3_NRT_014_001%2Fcmems_obs-wave_glo_phy-swh_nrt_cfo-l3_PT1S_202211";

const log = msg => {
  document.getElementById("log").textContent += "\n" + msg;
};

function floorTo3hUTC(date) {
  const d = new Date(date);
  d.setUTCHours(Math.floor(d.getUTCHours() / 3) * 3, 0, 0, 0);
  return d;
}

function ymdh(d) {
  return d.toISOString().slice(0,13).replace(/[-:]/g,"");
}

async function testFetch() {
  // UTC now - 6h
  let t = new Date(Date.now() - 6 * 3600 * 1000);
  t = floorTo3hUTC(t);
  const t2 = new Date(t.getTime() + 3 * 3600 * 1000);

  const dir =
    `${t.getUTCFullYear()}/` +
    `${String(t.getUTCMonth()+1).padStart(2,"0")}/` +
    `${String(t.getUTCDate()).padStart(2,"0")}`;

  const fname =
    `global_vavh_l3_rt_cfo_${ymdh(t)}0000_${ymdh(t2)}0000.nc`;

  const url = `${BASE}%2F${dir}%2F${fname}` +
              `&subdataset=cmems_obs-wave_glo_phy-swh_nrt_cfo-l3_PT1S_202211`;

  log("target time (UTC): " + t.toISOString());
  log("file name: " + fname);
  log("raw url:");
  log(url);

  const fetchURL = PROXY + encodeURIComponent(url);
  log("proxy url:");
  log(fetchURL);

  const res = await fetch(fetchURL);

  log("HTTP status: " + res.status);

  if (!res.ok) {
    throw new Error("fetch failed");
  }

  const buf = await res.arrayBuffer();
  log("downloaded bytes: " + buf.byteLength);

  if (buf.byteLength > 0) {
    log("✅ nc file fetched successfully");
  } else {
    log("⚠️ file size is zero");
  }
}

testFetch().catch(e => {
  log("❌ ERROR: " + e);
});
</script>

</body>
</html>
