<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Copernicus SWH latest</title>

  <!-- PyScript -->
  <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css">
  <script defer src="https://pyscript.net/latest/pyscript.js"></script>

  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
    }
    #status {
      margin-bottom: 10px;
      font-weight: bold;
    }
  </style>

  <py-config>
packages = ["xarray", "numpy", "matplotlib"]
  </py-config>
</head>

<body>
<h2>Copernicus Significant Wave Height (SWH)</h2>
<div id="status">initializing…</div>

<!-- ============================= -->
<!-- PyScript -->
<!-- ============================= -->
<py-script>
import xarray as xr
import matplotlib.pyplot as plt

def load_and_plot(url):
    from js import document
    document.getElementById("status").innerText = "loading netCDF…"

    ds = xr.open_dataset(url)

    # Significant Wave Height
    swh = ds["VAVH"]

    plt.figure(figsize=(9,4))
    swh.isel(time=0).plot(cmap="viridis")
    plt.title("Significant Wave Height (m)")
    plt.tight_layout()
    plt.show()

    document.getElementById("status").innerText = "done"
</py-script>

<!-- ============================= -->
<!-- JavaScript -->
<!-- ============================= -->
<script>
function getLatestStartTimeUTC() {
  const now = new Date();
  const utc = new Date(now.getTime() + now.getTimezoneOffset() * 60000);

  // minus 6 hours
  utc.setHours(utc.getHours() - 6);

  // floor to 3-hour
  const h = utc.getHours();
  utc.setHours(Math.floor(h / 3) * 3, 0, 0, 0);

  return utc;
}

function fmt(dt) {
  const p = n => String(n).padStart(2, "0");
  return (
    dt.getUTCFullYear() +
    p(dt.getUTCMonth() + 1) +
    p(dt.getUTCDate()) +
    "T" +
    p(dt.getUTCHours()) +
    "0000"
  );
}

async function run() {
  const status = document.getElementById("status");

  const t0 = getLatestStartTimeUTC();
  const startStr = fmt(t0);

  const y = t0.getUTCFullYear();
  const m = String(t0.getUTCMonth() + 1).padStart(2, "0");
  const d = String(t0.getUTCDate()).padStart(2, "0");

  const baseURL =
    "https://data.marine.copernicus.eu/product/WAVE_GLO_PHY_SWH_L3_NRT_014_001/files" +
    "?path=WAVE_GLO_PHY_SWH_L3_NRT_014_001/" +
    "cmems_obs-wave_glo_phy-swh_nrt_cfo-l3_PT1S_202211/" +
    `${y}/${m}/${d}/`;

  status.innerText = "searching latest nc file…";

  const res = await fetch(baseURL);
  const text = await res.text();

  const re = new RegExp(
    `cmems_obs-wave_glo_phy-swh_nrt_cfo-l3_PT1S_202211_${startStr}_[0-9T]{15}_[0-9T]{15}\\.nc`
  );

  const match = text.match(re);
  if (!match) {
    status.innerText = "nc file not found";
    throw "nc file not found";
  }

  const ncURL = baseURL + match[0];
  console.log("NC URL:", ncURL);

  status.innerText = "loading nc…";

  pyscript.interpreter.globals.set("nc_url", ncURL);
  pyscript.runPython("load_and_plot(nc_url)");
}

run();
</script>

</body>
</html>
