<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Copernicus 最新ファイル確認</title>
<style>
body { font-family: monospace; }
pre { background: #f0f0f0; padding: 10px; }
</style>
</head>
<body>
<h2>Copernicus Marine 最新ファイルチェック</h2>
<div id="debug"></div>
<div id="latest"></div>

<script>
const debug = (msg) => {
    const div = document.getElementById('debug');
    div.innerHTML += msg + "\n";
};

const latestDiv = document.getElementById('latest');

const proxies = "https://copernicus.ryohorita105.workers.dev/";
const datasets = [
    "cmems_obs-wave_glo_phy-swh_nrt_cfo-l3_PT1S",
    "cmems_obs-wave_glo_phy-swh_nrt_c2-l3_PT1S",
    "cmems_obs-wave_glo_phy-swh_nrt_h2b-l3_PT1S",
    "cmems_obs-wave_glo_phy-swh_nrt_h2c-l3_PT1S",
    "cmems_obs-wave_glo_phy-swh_nrt_j3-l3_PT1S",
    "cmems_obs-wave_glo_phy-swh_nrt_al-l3_PT1S",
    "cmems_obs-wave_glo_phy-swh_nrt_s3a-l3_PT1S",
    "cmems_obs-wave_glo_phy-swh_nrt_s3b-l3_PT1S",
    "cmems_obs-wave_glo_phy-swh_nrt_s6a-l3_PT1S",
    "cmems_obs-wave_glo_phy-swh_nrt_swon-l3_PT1S"
];

// 現在UTCの1時間前 → 3時間単位切捨
function getTargetTime() {
    const now = new Date();
    const utc = new Date(now.getTime() + now.getTimezoneOffset()*60000);
    utc.setHours(utc.getHours() - 1); // 1時間前
    const h = Math.floor(utc.getHours() / 3) * 3; // 3時間単位
    utc.setHours(h,0,0,0);
    return utc;
}

function formatTimeUTC(date) {
    const pad = (n)=>n.toString().padStart(2,'0');
    return date.getUTCFullYear().toString()+
           pad(date.getUTCMonth()+1)+
           pad(date.getUTCDate())+'T'+
           pad(date.getUTCHours())+
           pad(date.getUTCMinutes())+
           pad(date.getUTCSeconds());
}

const targetTimeStr = formatTimeUTC(getTargetTime());
debug("Target time UTC (3h rounded): " + targetTimeStr);

async function fetchFileList(dataset) {
    try {
        const url = `${proxies}${dataset}/`;
        debug("Fetching: " + url);
        const resp = await fetch(url);
        if(!resp.ok) throw new Error(resp.statusText);
        const text = await resp.text();
        // Copernicus HTMLからリンク抽出
        const files = [...text.matchAll(/href="([^"]+\.nc)"/g)].map(m=>m[1]);
        debug(dataset + " files: " + files.join(", "));
        return files;
    } catch(e) {
        debug("Error fetching " + dataset + ": " + e);
        return [];
    }
}

async function main() {
    for(const ds of datasets) {
        const files = await fetchFileList(ds);
        const matched = files.filter(f=>f.includes(targetTimeStr));
        debug(ds + " matched: " + matched.join(", "));
        if(matched.length > 0) {
            latestDiv.innerHTML += `<p>${ds}: <b>${matched[matched.length-1]}</b></p>`;
        } else {
            latestDiv.innerHTML += `<p>${ds}: <i>no match</i></p>`;
        }
    }
}

main();
</script>
</body>
</html>
