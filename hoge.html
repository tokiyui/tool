<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>最新NCファイル取得デバッグ（global_vavh形式）</title>
<script src="https://pyscript.net/latest/pyscript.js"></script>
<style>
  body { font-family: sans-serif; padding: 20px; }
  #status { margin-top: 10px; white-space: pre-wrap; font-family: monospace; }
  button { margin-top: 10px; padding: 5px 10px; }
</style>
</head>
<body>

<h2>最新NCファイル取得デバッグ（global_vavh形式）</h2>

<button id="fetchBtn">JSで最新ファイル取得</button>
<div id="status"></div>

<!-- ===== JS部分 ===== -->
<script>
const PROXY = "https://worker.ryohorita105.workers.dev/?url=";
const BASE = "https://data.marine.copernicus.eu/product/WAVE_GLO_PHY_SWH_L3_NRT_014_001/files?path=WAVE_GLO_PHY_SWH_L3_NRT_014_001/global_vavh_l3_rt_cfo_";

function getLatestTime() {
    const now = new Date();
    const utcNow = new Date(now.getTime() + now.getTimezoneOffset() * 60000);
    const minus6 = new Date(utcNow.getTime() - 6*60*60*1000);
    const hour = Math.floor(minus6.getUTCHours()/3)*3;
    const latest = new Date(Date.UTC(minus6.getUTCFullYear(), minus6.getUTCMonth(), minus6.getUTCDate(), hour));
    const y = latest.getUTCFullYear();
    const m = String(latest.getUTCMonth()+1).padStart(2,'0');
    const d = String(latest.getUTCDate()).padStart(2,'0');
    const H = String(latest.getUTCHours()).padStart(2,'0');
    const M = "00";
    const S = "00";
    return { YYYYMMDDTHHMMSS: `${y}${m}${d}T${H}${M}${S}`, y, m, d };
}

async function fetchLatestNC() {
    const t = getLatestTime();
    const dirUrl = `${PROXY}${BASE}${t.y}/${t.m}/${t.d}/`;
    const status = document.getElementById("status");
    status.innerText = `[JS] ディレクトリURL: ${dirUrl}\n取得中...`;

    try {
        const resp = await fetch(dirUrl);
        status.innerText += `\n[JS] ディレクトリHTTPステータス: ${resp.status}`;
        if(!resp.ok) throw new Error(`HTTP error ${resp.status}`);
        const html = await resp.text();
        status.innerText += `\n[JS] HTML取得完了（length: ${html.length})`;

        const regex = new RegExp(`global_vavh_l3_rt_cfo_${t.YYYYMMDDTHHMMSS}_[^"]+\\.nc`, "g");
        const matches = html.match(regex);
        status.innerText += `\n[JS] 正規表現マッチ数: ${matches ? matches.length : 0}`;
        if(!matches || matches.length === 0) throw new Error("ファイルが見つかりません");

        const latestFile = matches[0];
        status.innerText += `\n[JS] 最新ファイル: ${latestFile}\n取得中...`;

        const fileResp = await fetch(`${PROXY}${BASE}${t.y}/${t.m}/${t.d}/${latestFile}`);
        status.innerText += `\n[JS] ファイルHTTPステータス: ${fileResp.status}`;
        if(!fileResp.ok) throw new Error(`HTTP error ${fileResp.status}`);
        const blob = await fileResp.blob();
        status.innerText += `\n[JS] ファイル取得成功: ${blob.size} bytes`;
    } catch(err) {
        status.innerText += `\n[JS] 取得失敗: ${err}`;
        console.error(err);
    }
}

document.getElementById("fetchBtn").addEventListener("click", fetchLatestNC);
</script>

<!-- ===== PyScript部分 ===== -->
<py-script>
import asyncio, datetime, re
from pyodide.http import pyfetch
from pyscript import Element

PROXY = "https://worker.ryohorita105.workers.dev/?url="
BASE = "https://data.marine.copernicus.eu/product/WAVE_GLO_PHY_SWH_L3_NRT_014_001/files?path=WAVE_GLO_PHY_SWH_L3_NRT_014_001/global_vavh_l3_rt_cfo_"

async def fetch_nc_py():
    status = Element("status")
    now = datetime.datetime.utcnow()
    minus6 = now - datetime.timedelta(hours=6)
    hour = (minus6.hour // 3) * 3
    latest = datetime.datetime(minus6.year, minus6.month, minus6.day, hour)
    YYYYMMDDTHHMMSS = latest.strftime("%Y%m%dT%H%M%S")
    
    dirUrl = f"{PROXY}{BASE}{latest.year:04d}/{latest.month:02d}/{latest.day:02d}/"
    status.write(f"\n[PyScript] ディレクトリURL: {dirUrl}\n取得中...", append=True)
    
    try:
        resp = await pyfetch(dirUrl)
        status.write(f"\n[PyScript] ディレクトリHTTPステータス: {resp.status}", append=True)
        if resp.status != 200: raise RuntimeError(f"HTTP error {resp.status}")
        html = await resp.string()
        status.write(f"\n[PyScript] HTML取得完了（length: {len(html)})", append=True)

        regex = re.compile(f"global_vavh_l3_rt_cfo_{YYYYMMDDTHHMMSS}_[^\"']+\\.nc")
        matches = regex.findall(html)
        status.write(f"\n[PyScript] 正規表現マッチ数: {len(matches)}", append=True)
        if not matches: raise RuntimeError("ファイルが見つかりません")
        latestFile = matches[0]
        status.write(f"\n[PyScript] 最新ファイル: {latestFile}\n取得中...", append=True)

        fileResp = await pyfetch(f"{PROXY}{BASE}{latest.year:04d}/{latest.month:02d}/{latest.day:02d}/{latestFile}")
        status.write(f"\n[PyScript] ファイルHTTPステータス: {fileResp.status}", append=True)
        if fileResp.status != 200: raise RuntimeError(f"HTTP error {fileResp.status}")
        data = await fileResp.bytes()
        status.write(f"\n[PyScript] ファイル取得成功: {len(data)} bytes", append=True)
    except Exception as e:
        status.write(f"\n[PyScript] 取得失敗: {e}", append=True)

async def setup_button():
    import js
    btn = js.document.createElement("button")
    btn.innerText = "PyScriptで最新ファイル取得"
    js.document.body.appendChild(btn)
    from pyodide.ffi import create_proxy
    btn.addEventListener("click", create_proxy(lambda e: asyncio.ensure_future(fetch_nc_py())))

asyncio.ensure_future(setup_button())
</py-script>

</body>
</html>
