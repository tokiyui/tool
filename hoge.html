<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Copernicus SWH DEBUG</title>

<link rel="stylesheet"
  href="https://pyscript.net/releases/2025.2.4/core.css">
<script type="module"
  src="https://pyscript.net/releases/2025.2.4/core.js"></script>

<style>
body { font-family: monospace; }
pre { background:#eee; padding:10px; white-space:pre-wrap; }
#status { font-weight:bold; color:#b00; }
</style>

<py-config>
packages = ["xarray", "numpy", "matplotlib"]
</py-config>
</head>

<body>

<h2>Copernicus SWH DEBUG</h2>
<div id="status">booting…</div>
<pre id="log"></pre>

<py-script>
import xarray as xr
import matplotlib.pyplot as plt
from js import document

def load_and_plot(url):
    document.getElementById("status").innerText = "PyScript: loading netCDF"
    ds = xr.open_dataset(url)
    swh = ds["VAVH"]

    plt.figure(figsize=(9,4))
    swh.isel(time=0).plot()
    plt.title("SWH")
    plt.show()

    document.getElementById("status").innerText = "PyScript: done"
</py-script>

<script>
const PROXY = "https://worker.ryohorita105.workers.dev/?url=";
const log = msg =>
  document.getElementById("log").textContent += msg + "\n";

function getLatestStartTimeUTC(offsetH) {
  const d = new Date();
  const utc = new Date(d.getTime() + d.getTimezoneOffset()*60000);
  utc.setHours(utc.getHours() - offsetH);
  utc.setHours(Math.floor(utc.getHours()/3)*3,0,0,0);
  return utc;
}

function fmt(dt) {
  const p=n=>String(n).padStart(2,"0");
  return (
    dt.getUTCFullYear() +
    p(dt.getUTCMonth()+1) +
    p(dt.getUTCDate()) +
    "T" +
    p(dt.getUTCHours()) +
    "0000"
  );
}

async function tryOnce(offsetH) {
  const t0 = getLatestStartTimeUTC(offsetH);
  const startStr = fmt(t0);

  const y=t0.getUTCFullYear();
  const m=String(t0.getUTCMonth()+1).padStart(2,"0");
  const d=String(t0.getUTCDate()).padStart(2,"0");

  log(`--- TRY offset ${offsetH}h → ${startStr} ---`);

  const baseURL =
    "https://data.marine.copernicus.eu/product/WAVE_GLO_PHY_SWH_L3_NRT_014_001/files" +
    "?path=WAVE_GLO_PHY_SWH_L3_NRT_014_001/" +
    "cmems_obs-wave_glo_phy-swh_nrt_cfo-l3_PT1S_202211/" +
    `${y}/${m}/${d}/`;

  log("DIR URL:");
  log(baseURL);

  const r = await fetch(PROXY + encodeURIComponent(baseURL));
  const txt = await r.text();

  log("LISTING HEAD:");
  log(txt.slice(0,500));

  const re = new RegExp(
    `cmems_obs-wave_glo_phy-swh_nrt_cfo-l3_PT1S_202211_${startStr}_[^"]+\\.nc`
  );

  const m2 = txt.match(re);
  if(!m2) {
    log("→ NOT FOUND");
    return null;
  }

  log("FOUND:");
  log(m2[0]);
  return PROXY + encodeURIComponent(baseURL + m2[0]);
}

async function run() {
  document.getElementById("status").innerText = "JS: searching…";

  for (const h of [6,9,12]) {
    const url = await tryOnce(h);
    if(url) {
      document.getElementById("status").innerText = "JS: calling PyScript";
      pyscript.interpreter.globals.set("nc_url", url);
      pyscript.runPython("load_and_plot(nc_url)");
      return;
    }
  }

  document.getElementById("status").innerText = "ALL FAILED";
}

window.addEventListener("py:ready", run);
</script>

</body>
</html>
