<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Copernicus 最新ファイル確認</title>
<style>
body { font-family: monospace; }
pre { background: #f0f0f0; padding: 10px; }
</style>
</head>
<body>
<h2>Copernicus Marine 最新ファイルチェック</h2>
<div id="debug"></div>
<div id="latest"></div>

<script>
const debug = (msg) => {
    document.getElementById('debug').innerHTML += msg + "\n";
};
const latestDiv = document.getElementById('latest');

const datasets = [
    "cmems_obs-wave_glo_phy-swh_nrt_cfo-l3_PT1S",
    "cmems_obs-wave_glo_phy-swh_nrt_c2-l3_PT1S",
    "cmems_obs-wave_glo_phy-swh_nrt_h2b-l3_PT1S",
    "cmems_obs-wave_glo_phy-swh_nrt_h2c-l3_PT1S",
    "cmems_obs-wave_glo_phy-swh_nrt_j3-l3_PT1S",
    "cmems_obs-wave_glo_phy-swh_nrt_al-l3_PT1S",
    "cmems_obs-wave_glo_phy-swh_nrt_s3a-l3_PT1S",
    "cmems_obs-wave_glo_phy-swh_nrt_s3b-l3_PT1S",
    "cmems_obs-wave_glo_phy-swh_nrt_s6a-l3_PT1S",
    "cmems_obs-wave_glo_phy-swh_nrt_swon-l3_PT1S"
];

// UTC現在の1時間前 → 3時間単位切捨
function getTargetTime() {
    const now = new Date();
    const utc = new Date(now.getTime() + now.getTimezoneOffset()*60000);
    utc.setHours(utc.getHours() - 1);
    const h = Math.floor(utc.getHours()/3)*3;
    utc.setHours(h,0,0,0);
    return utc;
}

function formatTimeUTC(date) {
    const pad = n=>n.toString().padStart(2,'0');
    return date.getUTCFullYear().toString()+
           pad(date.getUTCMonth()+1)+
           pad(date.getUTCDate())+'T'+
           pad(date.getUTCHours())+
           pad(date.getUTCMinutes())+
           pad(date.getUTCSeconds());
}

const targetTimeStr = formatTimeUTC(getTargetTime());
debug("Target time UTC (3h rounded): " + targetTimeStr);

async function fetchFileList(dataset) {
    try {
        const year = new Date().getUTCFullYear();
        const month = (new Date().getUTCMonth()+1).toString().padStart(2,'0');

        // Copernicus URL
        const baseUrl = `https://data.marine.copernicus.eu/product/WAVE_GLO_PHY_SWH_L3_NRT_014_001/files?path=WAVE_GLO_PHY_SWH_L3_NRT_014_001%2F${dataset}_202211%2F${year}%2F${month}%2F&subdataset=${dataset}_202211`;

        // Worker経由でJSON取得
        const workerUrl = `https://copernicus.ryohorita105.workers.dev/?target=${encodeURIComponent(baseUrl)}`;
        debug("Fetching via Worker: " + workerUrl);

        const resp = await fetch(workerUrl);
        const data = await resp.json();
        debug(dataset + " files: " + data.files.join(", "));
        return data.files;
    } catch(e) {
        debug("Error fetching " + dataset + ": " + e);
        return [];
    }
}

async function main() {
    for(const ds of datasets) {
        const files = await fetchFileList(ds);
        const matched = files.filter(f=>f.includes(targetTimeStr));
        debug(ds + " matched: " + matched.join(", "));
        if(matched.length > 0) {
            latestDiv.innerHTML += `<p>${ds}: <b>${matched[matched.length-1]}</b></p>`;
        } else {
            latestDiv.innerHTML += `<p>${ds}: <i>no match</i></p>`;
        }
    }
}

main();
</script>
</body>
</html>
