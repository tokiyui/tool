<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>AMeDAS Tw Viewer (JST)</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
html, body { margin:0; height:100%; }
#map { height:100%; }

.control {
  position:absolute;
  top:10px;
  left:10px;
  background:white;
  padding:8px;
  z-index:1000;
  font-size:13px;
}

.value-box {
  padding:2px 4px;
  border-radius:3px;
  font-size:11px;
  min-width:32px;
  text-align:center;
}
.temp-hot  { background:#ffb6c1; }
.temp-mid  { background:#ffffff; }
.temp-cold { background:#add8e6; }

.wind-arrow {
  width:0;
  height:0;
  border-left:6px solid transparent;
  border-right:6px solid transparent;
  border-bottom:16px solid;
  transform-origin:50% 75%;
}
</style>
</head>
<body>

<div id="map"></div>

<div class="control">
  <div id="timeLabel"></div>
  <button onclick="stepTime(-10)">◀10分</button>
  <button onclick="stepTime(10)">10分▶</button><br>
  <label><input type="radio" name="elem" value="temp" checked>気温</label>
  <label><input type="radio" name="elem" value="tw">湿球</label>
  <label><input type="radio" name="elem" value="td">露点</label>
</div>

<script>
const map = L.map("map").setView([35.8, 139.5], 7);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

let stationLayer = L.layerGroup().addTo(map);
let radarLayer;
let amedasTable;

let currentJST;
let initialJST;

fetch("https://www.jma.go.jp/bosai/amedas/const/amedastable.json")
.then(r => r.json())
.then(j => { amedasTable = j; initTime(); });

function initTime() {
  const now = new Date();
  now.setMinutes(Math.floor(now.getMinutes()/10)*10, 0, 0);
  currentJST = new Date(now);
  initialJST = new Date(now);
  loadData();
}

function stepTime(min) {
  const next = new Date(currentJST.getTime() + min*60000);
  if (next > initialJST) return;
  if (initialJST - next > 48*3600*1000) return;
  currentJST = next;
  loadData();
}

function fmtJST(d) {
  return d.getFullYear()
    + String(d.getMonth()+1).padStart(2,"0")
    + String(d.getDate()).padStart(2,"0")
    + String(d.getHours()).padStart(2,"0")
    + String(d.getMinutes()).padStart(2,"0");
}

function toUTC(d) {
  return new Date(d.getTime() - 9*3600*1000);
}

async function fetchAmedas(jst) {
  for (let i=0;i<6;i++) {
    const t = new Date(jst.getTime() - i*600000);
    const url = `https://www.jma.go.jp/bosai/amedas/data/map/${fmtJST(t)}00.json`;
    const r = await fetch(url);
    if (r.ok) return {data:await r.json(), time:t};
  }
  return null;
}

function wetBulb(T, RH) {
  return T*Math.atan(0.151977*Math.sqrt(RH+8.313659))
    + Math.atan(T+RH)
    - Math.atan(RH-1.676331)
    + 0.00391838*RH**1.5*Math.atan(0.023101*RH)
    - 4.686035;
}

function dewPoint(T, RH) {
  const a=17.27,b=237.7;
  const alpha=(a*T)/(b+T)+Math.log(RH/100);
  return (b*alpha)/(a-alpha);
}

function windColor(v) {
  if (v<3) return "white";
  if (v<6) return "blue";
  if (v<8) return "yellow";
  if (v<10) return "orange";
  return "red";
}

function tempClass(t) {
  if (t>=2) return "temp-hot";
  if (t>=0) return "temp-mid";
  return "temp-cold";
}

async function loadData() {
  stationLayer.clearLayers();

  const res = await fetchAmedas(currentJST);
  if (!res) return;

  document.getElementById("timeLabel").innerText =
    `JST ${res.time.toLocaleString("ja-JP")}`;

  const elem = document.querySelector("input[name=elem]:checked").value;

  Object.entries(res.data).forEach(([id,v])=>{
    const s = amedasTable[id];
    if (!s || !v.temp || v.temp[1]!==0) return;

    const lat = s.lat[0]+s.lat[1]/60;
    const lon = s.lon[0]+s.lon[1]/60;

    const T = v.temp[0];
    const RH = (v.humidity && v.humidity[1]===0) ? v.humidity[0] : null;

    let val = T;
    if (elem==="tw" && RH!==null) val = wetBulb(T,RH);
    if (elem==="td" && RH!==null) val = dewPoint(T,RH);
    if (!isFinite(val)) return;

    const icon = L.divIcon({
      className:"",
      html:`<div class="value-box ${tempClass(val)}">${val.toFixed(1)}</div>`
    });
    L.marker([lat,lon],{icon}).addTo(stationLayer);

    if (v.wind && v.windDirection &&
        v.wind[1]===0 && v.windDirection[1]===0) {
      const arrow = L.divIcon({
        className:"",
        html:`<div class="wind-arrow"
          style="border-bottom-color:${w
