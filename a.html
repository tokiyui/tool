<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<title>AMeDAS Tw Viewer</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
html, body { margin:0; padding:0; height:100%; }
#map { width:100%; height:100%; }

.control {
  position:absolute;
  top:10px;
  left:10px;
  background:white;
  padding:8px;
  z-index:1000;
  font-size:13px;
}

.value-box {
  padding:2px 4px;
  border-radius:3px;
  font-size:11px;
  text-align:center;
  min-width:32px;
}

.temp-hot { background:#ffb6c1; }
.temp-mid { background:#ffffff; }
.temp-cold { background:#add8e6; }

.wind-arrow {
  width:0;
  height:0;
  border-left:6px solid transparent;
  border-right:6px solid transparent;
  border-bottom:16px solid black;
  transform-origin:50% 75%;
}
</style>
</head>
<body>

<div id="map"></div>

<div class="control">
  <div id="timeLabel"></div>
  <button onclick="stepTime(-10)">◀ 10分</button>
  <button onclick="stepTime(10)">10分 ▶</button>
  <br>
  <label><input type="radio" name="elem" value="temp" checked> 気温</label>
  <label><input type="radio" name="elem" value="tw"> 湿球温度</label>
  <label><input type="radio" name="elem" value="td"> 露点温度</label>
</div>

<script>
const map = L.map("map").setView([35.8, 139.5], 7);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "© OpenStreetMap"
}).addTo(map);

let stationLayer = L.layerGroup().addTo(map);
let radarLayer;

let amedasTable;
let currentTime;
let initialTime;

fetch("https://www.jma.go.jp/bosai/amedas/const/amedastable.json")
.then(r => r.json())
.then(j => {
  amedasTable = j;
  initTime();
});

function initTime() {
  const now = new Date();
  now.setUTCMinutes(Math.floor(now.getUTCMinutes() / 10) * 10);
  now.setUTCSeconds(0);
  now.setUTCMilliseconds(0);
  currentTime = new Date(now);
  initialTime = new Date(now);
  loadData();
}

function stepTime(min) {
  const next = new Date(currentTime.getTime() + min * 60000);
  if (next > initialTime) return;
  if (initialTime - next > 48 * 3600 * 1000) return;
  currentTime = next;
  loadData();
}

function ymdhm(d) {
  return d.getUTCFullYear()
    + String(d.getUTCMonth()+1).padStart(2,"0")
    + String(d.getUTCDate()).padStart(2,"0")
    + String(d.getUTCHours()).padStart(2,"0")
    + String(d.getUTCMinutes()).padStart(2,"0");
}

async function fetchAmedas(time) {
  for (let i=0; i<6; i++) {
    const t = new Date(time.getTime() - i*600000);
    const url = `https://www.jma.go.jp/bosai/amedas/data/map/${ymdhm(t)}00.json`;
    const r = await fetch(url);
    if (r.ok) return { data: await r.json(), time: t };
  }
  return null;
}

function wetBulb(T, RH) {
  const Tw = T * Math.atan(0.151977 * Math.sqrt(RH + 8.313659))
    + Math.atan(T + RH)
    - Math.atan(RH - 1.676331)
    + 0.00391838 * RH ** 1.5 * Math.atan(0.023101 * RH)
    - 4.686035;
  return Tw;
}

function dewPoint(T, RH) {
  const a = 17.27, b = 237.7;
  const alpha = (a * T) / (b + T) + Math.log(RH/100);
  return (b * alpha) / (a - alpha);
}

function windColor(v) {
  if (v < 3) return "white";
  if (v < 6) return "blue";
  if (v < 8) return "yellow";
  if (v < 10) return "orange";
  return "red";
}

function tempClass(t) {
  if (t >= 2) return "temp-hot";
  if (t >= 0) return "temp-mid";
  return "temp-cold";
}

async function loadData() {
  stationLayer.clearLayers();

  const res = await fetchAmedas(currentTime);
  if (!res) return;

  document.getElementById("timeLabel").innerText =
    `UTC ${res.time.toISOString().slice(0,16).replace("T"," ")}`;

  const elem = document.querySelector("input[name=elem]:checked").value;

  Object.entries(res.data).forEach(([id, v]) => {
    const s = amedasTable[id];
    if (!s || !v.temp) return;

    const lat = s.lat[0] + s.lat[1]/60;
    const lon = s.lon[0] + s.lon[1]/60;

    const T = v.temp[0];
    const RH = v.humidity ? v.humidity[0] : null;

    let val = T;
    if (elem === "tw" && RH !== null) val = wetBulb(T, RH);
    if (elem === "td" && RH !== null) val = dewPoint(T, RH);

    const box = L.divIcon({
      className:"",
      html:`<div class="value-box ${tempClass(val)}">${val.toFixed(1)}</div>`
    });

    L.marker([lat, lon], {icon:box}).addTo(stationLayer);

    if (v.wind && v.windDirection) {
      const arrow = L.divIcon({
        className:"",
        html:`<div class="wind-arrow"
          style="border-bottom-color:${windColor(v.wind[0])};
          transform:rotate(${v.windDirection[0]*22.5}deg);"></div>`
      });
      L.marker([lat, lon], {icon:arrow}).addTo(stationLayer);
    }
  });

  if (radarLayer) map.removeLayer(radarLayer);
  radarLayer = L.tileLayer(
    `https://www.jma.go.jp/bosai/jmatile/data/nowc/${ymdhm(res.time)}00/none/${ymdhm(res.time)}00/surf/hrpns/{z}/{x}/{y}.png`,
    { opacity:0.6 }
  ).addTo(map);
}

document.querySelectorAll("input[name=elem]").forEach(e=>{
  e.onchange = loadData;
});
</script>
</body>
</html>
