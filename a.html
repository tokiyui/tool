<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>AMeDAS Tw Viewer</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
html, body { margin:0; height:100%; }
#map { width:100%; height:100%; }

.control {
  position:absolute;
  top:10px;
  left:10px;
  background:white;
  padding:8px;
  z-index:1000;
  font-size:13px;
}

.value-box {
  padding:2px 4px;
  border-radius:3px;
  font-size:11px;
  text-align:center;
  min-width:36px;
}

.temp-hot  { background:#ffb6c1; }
.temp-mid  { background:#ffffff; }
.temp-cold { background:#add8e6; }

/* 風矢印（白でも黒縁が必ず出る） */
.wind-arrow {
  width:0;
  height:0;
  border-left:6px solid transparent;
  border-right:6px solid transparent;
  border-bottom:16px solid black;
  transform-origin:50% 75%;
  filter:
    drop-shadow(1px 0 0 black)
    drop-shadow(-1px 0 0 black)
    drop-shadow(0 1px 0 black)
    drop-shadow(0 -1px 0 black);
}
</style>
</head>
<body>

<div id="map"></div>

<div class="control">
  <div id="timeLabel"></div>
  <button onclick="stepTime(-10)">◀ 10分</button>
  <button onclick="stepTime(10)">10分 ▶</button><br>
  <label><input type="radio" name="elem" value="temp" checked> 気温</label>
  <label><input type="radio" name="elem" value="tw"> 湿球温度</label>
  <label><input type="radio" name="elem" value="td"> 露点温度</label>
  <label><input type="radio" name="elem" value="rh"> 湿度</label>
</div>

<script>
// =====================
// Map（初期：関東地方）
// =====================
const map = L.map("map").setView([35.7, 139.5], 7);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

let stationLayer = L.layerGroup().addTo(map);
let radarLayer;
let amedasTable;

// =====================
// Time (JST)
// =====================
let currentTimeJST;
let initialTimeJST;

fetch("https://www.jma.go.jp/bosai/amedas/const/amedastable.json")
.then(r => r.json())
.then(j => {
  amedasTable = j;
  initTime();
});

function initTime() {
  const now = new Date();
  now.setMinutes(Math.floor(now.getMinutes()/10)*10, 0, 0);
  currentTimeJST = new Date(now);
  initialTimeJST = new Date(now);
  loadData();
}

function stepTime(min) {
  const t = new Date(currentTimeJST.getTime() + min*60000);
  if (t > initialTimeJST) return;
  if (initialTimeJST - t > 48*3600*1000) return;
  currentTimeJST = t;
  loadData();
}

function ymdhm(d) {
  return d.getFullYear()
    + String(d.getMonth()+1).padStart(2,"0")
    + String(d.getDate()).padStart(2,"0")
    + String(d.getHours()).padStart(2,"0")
    + String(d.getMinutes()).padStart(2,"0");
}

function formatJST(d) {
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}
          ${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")} JST`;
}

function toUTC(d) {
  return new Date(d.getTime() - 9*3600*1000);
}

// =====================
// Fetch AMeDAS
// =====================
async function fetchAmedas(timeJST) {
  for (let i=0; i<6; i++) {
    const t = new Date(timeJST.getTime() - i*600000);
    const url = `https://www.jma.go.jp/bosai/amedas/data/map/${ymdhm(t)}00.json`;
    const r = await fetch(url);
    if (r.ok) return { data: await r.json(), time: t };
  }
  return null;
}

// =====================
// Meteorology
// =====================
function wetBulb(T, RH) {
  return T*Math.atan(0.151977*Math.sqrt(RH+8.313659))
    + Math.atan(T+RH)
    - Math.atan(RH-1.676331)
    + 0.00391838*RH**1.5*Math.atan(0.023101*RH)
    - 4.686035;
}

function dewPoint(T, RH) {
  const a=17.27, b=237.7;
  const α=(a*T)/(b+T)+Math.log(RH/100);
  return (b*α)/(a-α);
}

function windColor(v) {
  if (v < 3) return "white";
  if (v < 6) return "blue";
  if (v < 8) return "yellow";
  if (v < 10) return "orange";
  return "red";
}

function tempClass(t) {
  if (t >= 2) return "temp-hot";
  if (t >= 0) return "temp-mid";
  return "temp-cold";
}

// =====================
// Main draw
// =====================
async function loadData() {
  if (!amedasTable) return;
  stationLayer.clearLayers();

  const res = await fetchAmedas(currentTimeJST);
  if (!res) return;

  document.getElementById("timeLabel").innerText = formatJST(res.time);

  const elem = document.querySelector("input[name=elem]:checked").value;

  Object.entries(res.data).forEach(([id,v])=>{
    const s = amedasTable[id];
    if (!s || !v.temp || v.temp[1] !== 0) return;

    const T = v.temp[0];
    const RH = (v.humidity && v.humidity[1] === 0) ? v.humidity[0] : NaN;

    const lat = s.lat[0] + s.lat[1]/60;
    const lon = s.lon[0] + s.lon[1]/60;

    let val=null, text=null;

    if (elem==="temp") { val=T; text=T.toFixed(1)+"℃"; }
    else if (elem==="tw" && !isNaN(RH)) { val=wetBulb(T,RH); text=val.toFixed(1)+"℃"; }
    else if (elem==="td" && !isNaN(RH)) { val=dewPoint(T,RH); text=val.toFixed(1)+"℃"; }
    else if (elem==="rh" && !isNaN(RH)) { text=Math.round(RH)+"%"; }
    else return;

    const cls=(elem!=="rh")?tempClass(val):"";

    L.marker([lat,lon],{
      icon:L.divIcon({className:"",html:`<div class="value-box ${cls}">${text}</div>`})
    }).addTo(stationLayer);

    if (v.wind && v.windDirection &&
        v.wind[1]===0 && v.windDirection[1]===0) {
      const ws=v.wind[0], wd=v.windDirection[0];
      L.marker([lat,lon],{
        icon:L.divIcon({
          className:"",
          html:`<div class="wind-arrow"
            style="border-bottom-color:${windColor(ws)};
            transform:rotate(${wd*22.5}deg);"></div>`
        })
      }).addTo(stationLayer);
    }
  });

  // ===== Radar（ズーム対策込み） =====
  if (radarLayer) map.removeLayer(radarLayer);

  const utc = toUTC(res.time);
  radarLayer = L.tileLayer(
    `https://www.jma.go.jp/bosai/jmatile/data/nowc/${ymdhm(utc)}00/none/${ymdhm(utc)}00/surf/hrpns/{z}/{x}/{y}.png`,
    {
      opacity:0.6,
      minZoom:5   // ← これが重要
    }
  );

  if (map.getZoom() >= 5) radarLayer.addTo(map);

  map.off("zoomend").on("zoomend", ()=>{
    if (map.getZoom() >= 5) {
      if (!map.hasLayer(radarLayer)) radarLayer.addTo(map);
    } else {
      if (map.hasLayer(radarLayer)) map.removeLayer(radarLayer);
    }
  });
}

document.querySelectorAll("input[name=elem]").forEach(e=>{
  e.onchange = loadData;
});
</script>
</body>
</html>
