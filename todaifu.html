<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>風向SVGマップ（海保＋AMeDAS）</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html, body {
  margin: 0;
  height: 100%;
}
#map {
  height: 100vh;
}

.wind-speed-label {
  font-size: 18px;
  font-weight: bold;
  color: black;
  text-shadow: 1px 1px 2px white;
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  pointer-events: none;
  z-index: 1000;
}
</style>
</head>

<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// ======================================
// 地図
// ======================================
const map = L.map('map').setView([42.0, 143.0], 6);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

// ======================================
// 風速→色
// ======================================
const getArrowColor = (speed) => {
  if (speed >= 20) return "red";
  if (speed >= 15) return "orange";
  if (speed >= 10) return "yellow";
  return "blue";
};

// ======================================
// 風向変換
// ======================================
const windDirToAngleText = (dir) => ({
  "南":0,"南南西":22.5,"南西":45,"西南西":67.5,
  "西":90,"西北西":112.5,"北西":135,"北北西":157.5,
  "北":180,"北北東":202.5,"北東":225,"東北東":247.5,
  "東":270,"東南東":292.5,"南東":315,"南南東":337.5
}[dir] ?? null);

const windDir16ToAngle = (dir) =>
  (dir >= 1 && dir <= 16) ? (dir - 1) * 22.5 : null;

// ======================================
// AMeDAS 時刻
// ======================================
const getAmedasTimeString = () => {
  const d = new Date();
  d.setMinutes(d.getMinutes() - 10);
  d.setMinutes(Math.floor(d.getMinutes() / 10) * 10);
  d.setSeconds(0);

  const p = n => n.toString().padStart(2, "0");
  return (
    d.getFullYear() +
    p(d.getMonth() + 1) +
    p(d.getDate()) +
    p(d.getHours()) +
    p(d.getMinutes()) +
    "00"
  );
};

// ======================================
// SVGアイコン生成
// labelColor を指定可能
// ======================================
const makeWindIcon = (angle, speed, color, labelColor = "black") => {
  return L.divIcon({
    className: '',
    html: `
      <div style="position:relative;width:48px;height:48px;">
        <svg width="48" height="48" viewBox="0 0 48 48"
             style="transform:rotate(${angle}deg);
                    position:absolute;top:0;left:0;">
          <polygon points="24,2 28,10 24,8 20,10" fill="${color}"/>
          <line x1="24" y1="2" x2="24" y2="28"
                stroke="${color}" stroke-width="2"/>
        </svg>
        <div class="wind-speed-label"
             style="color:${labelColor};">
          ${speed}
        </div>
      </div>
    `,
    iconSize: [48,48],
    iconAnchor: [24,24]
  });
};

// ======================================
// ① 海保（灯台）※風速文字は白
// ======================================
const proxy = "https://api.allorigins.win/raw?url=";
const kaihoUrl =
  "https://www6.kaiho.mlit.go.jp/micsgis/KishouGenkyouPoint/attribute" +
  "?lon=135&lat=35&stlon=105&stlat=20&edlon=165&edlat=50";

fetch(proxy + encodeURIComponent(kaihoUrl))
  .then(r => r.json())
  .then(data => {
    data.forEach(e => {
      if (!e.shp) return;

      const m = e.shp.match(/POINT\(([-\d.]+) ([-\d.]+)\)/);
      if (!m) return;

      const lon = +m[1];
      const lat = +m[2];

      const angle = windDirToAngleText(e.fuukou);
      const speed = parseFloat(e.fuusoku);
      if (angle === null || isNaN(speed)) return;

      const icon = makeWindIcon(
        angle,
        speed,
        getArrowColor(speed),
        "white"          // ← 灯台のみ白
      );

      L.marker([lat, lon], { icon }).addTo(map)
        .bindPopup(`
          <a href="${e.url}" target="_blank">
            ${e.kansokujo_mei}
          </a><br>
          風向: ${e.fuukou}<br>
          風速: ${e.fuusoku}<br>
          観測日時: ${e.kansoku_date}
        `);
    });
  });

// ======================================
// ② AMeDAS（10m/s以上・リンク追加）
// ======================================
const timeStr = getAmedasTimeString();

Promise.all([
  fetch(`https://www.jma.go.jp/bosai/amedas/data/map/${timeStr}.json`)
    .then(r => r.json()),
  fetch("https://www.jma.go.jp/bosai/amedas/const/amedastable.json")
    .then(r => r.json())
]).then(([amedas, table]) => {

  Object.keys(amedas).forEach(code => {
    const obs = amedas[code];
    const meta = table[code];
    if (!meta) return;

    const speed = obs.wind?.[0];
    const dir = obs.windDirection?.[0];
    if (speed == null || dir == null || speed < 10) return;

    const angle = windDir16ToAngle(dir);
    if (angle === null) return;

    const lat = meta.lat[0] + meta.lat[1] / 60;
    const lon = meta.lon[0] + meta.lon[1] / 60;

    const icon = makeWindIcon(
      angle,
      speed.toFixed(1),
      getArrowColor(speed)
    );

    const amedasUrl =
      `https://www.jma.go.jp/bosai/amedas/#amdno=${code}`;

    L.marker([lat, lon], { icon }).addTo(map)
      .bindPopup(`
        <a href="${amedasUrl}" target="_blank">
          ${meta.kjName}
        </a><br>
        風速: ${speed} m/s<br>
        観測時刻: ${timeStr}
      `);
  });
});

// ======================================
// ③ NOAA 船舶観測（白色・リンクなし）
// ======================================
const ndbcUrl =
  "https://www.ndbc.noaa.gov/ship_obs.php?uom=M&time=2";

// NOAA も CORS 回避で allorigins 使用
fetch(proxy + encodeURIComponent(ndbcUrl))
  .then(r => r.text())
  .then(text => {

    // <pre> 内の <span> 行だけ抜き出す
    const lines = text
      .split("\n")
      .filter(l => l.startsWith("<span>SHIP"));

    lines.forEach(line => {
      // HTMLタグ除去
      const clean = line.replace(/<[^>]+>/g, "").trim();
      const cols = clean.split(/\s+/);

      /*
        cols 構成（例）
        0 SHIP
        1 HOUR
        2 LAT
        3 LON
        4 WDIR
        5 WSPD
      */
      if (cols.length < 6) return;

      const hour = cols[1];
      const lat  = parseFloat(cols[2]);
      const lon  = parseFloat(cols[3]);
      const wdir = parseFloat(cols[4]);
      const wspd = parseFloat(cols[5]);

      // 欠損除外
      if (
        isNaN(lat) || isNaN(lon) ||
        isNaN(wdir) || isNaN(wspd)
      ) return;

      // 範囲制限（北緯20–50、東経120–150）
      if (
        lat < 20 || lat > 50 ||
        lon < 120 || lon > 150
      ) return;

      // NOAAは「風が吹いてくる方向」
      const angle = wdir;

      const icon = makeWindIcon(
        angle,
        wspd.toFixed(1),
        getArrowColor(wspd),
        "white"      // ← 船舶も白
      );

      L.marker([lat, lon], { icon }).addTo(map);
    });
  });

</script>
</body>
</html>
